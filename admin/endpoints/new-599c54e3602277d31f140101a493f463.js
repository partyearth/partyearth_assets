pe.CloseButton=function(a,c){pe.init_widget(this,a);this.close_button=a.find(".CloseButton");if("function"===typeof c)this.close_button.click(c);else switch(c){case pe.CloseButton.close_methods.REMOVE:this.close_button.click(this.callback(this.remove_container));break;case pe.CloseButton.close_methods.HIDE:this.close_button.click(this.callback(this.hide_container));break;default:alert("unknown value for 'close_method' parameter.")}};pe.CloseButton.close_methods={REMOVE:"REMOVE",HIDE:"HIDE"};
pe.CloseButton.events={CLOSED:"CloseButton_CLOSED"};pe.CloseButton.prototype.remove_container=function(){this.container.detach();this.fire_event(pe.CloseButton.events.CLOSED);this.container.remove();return!1};pe.CloseButton.prototype.hide_container=function(){this.fire_event(pe.CloseButton.events.CLOSED);this.container.hide();return!1};
pe.GeneralAutocompleteInputModule=function(a,c,b,d){pe.init_widget(this,a);this.autocomplete_data_or_url=c;this.input_field_name=b;this.container.html(this.html());this.dummy_input_field=this.container.find(".DummyInputField");this.autocomplete_input_field=this.container.find(".AutocompleteField");this.autocomplete_handler();this.selected_data_list_div=this.container.find(".SelectedDataList");this.selected_data_list_div.sortable();d&&this.add_data_to_list(d)};
pe.GeneralAutocompleteInputModule.events={SELECTED:"GeneralAutocompleteInputModule_SELECTED",REMOVED:"GeneralAutocompleteInputModule_REMOVED",EMPTIED:"GeneralAutocompleteInputMOdule_EMPTIED"};pe.GeneralAutocompleteInputModule.prototype.add_data_to_list=function(a){this.remove_dummy_row();$.each(a,this.callback(function(a,b){-1===$.inArray(b.id.toString(),this.all_values())&&this.autocomplete_data_selected(b.label,b.id,b.category)}))};
pe.GeneralAutocompleteInputModule.prototype.add_dummy_row=function(){this.dummy_input_field||(this.dummy_input_field=$('<input class="DummyInputField"        type="hidden" name="'+this.input_field_name+'"       value="x_mock_single_value_x">'),this.autocomplete_input_field.after(this.dummy_input_field))};pe.GeneralAutocompleteInputModule.prototype.all_values=function(){return this.selected_data_list_div.find('[name="'+this.input_field_name+'"]').map(function(){return this.value}).toArray()};
pe.GeneralAutocompleteInputModule.prototype.autocomplete_data_selected=function(a,c,b){this.remove_dummy_row();this.selected_data_list_div.append(this.selected_data_html(a,c,b));(new pe.CloseButton(this.selected_data_list_div.find(".SelectedInputData").last(),pe.CloseButton.close_methods.REMOVE)).bind_event(pe.CloseButton.events.CLOSED,this.callback(this.close_button_clicked))};
pe.GeneralAutocompleteInputModule.prototype.autocomplete_handler=function(){this.autocomplete_input_field.autocomplete({source:this.set_autocomplete_data(),minLength:1,close:this.callback(function(){this.autocomplete_input_field.val("")}),select:this.callback(function(a,c){var b=c.item;this.autocomplete_data_selected(b.label,b.id,b.category);this.fire_event(pe.GeneralAutocompleteInputModule.events.SELECTED,b.id)})}).data("autocomplete")._renderItem=function(a,c){c.display_label=c.category?pe.templatize("{{label}} ({{category}})",
c):c.label;return $("<li></li>").data("item.autocomplete",c).append(pe.templatize("<a>{{display_label}}</a>",c)).appendTo(a)}};
pe.GeneralAutocompleteInputModule.prototype.set_autocomplete_data=function(){return"string"==typeof this.autocomplete_data_or_url?this.callback(function(a,c){$.getJSON(this.autocomplete_data_or_url,{term:this.autocomplete_input_field.val(),val:this.all_values().join(",")},function(b){pe.GeneralAutocompleteInputModule.sort_autocomplete_results(b,a,c)})}):this.callback(pe.GeneralAutocompleteInputModule.sort_autocomplete_results,this.autocomplete_data_or_url)};
pe.GeneralAutocompleteInputModule.sort_autocomplete_results=function(a,c,b){var d=pe.normalize(c.term).toLowerCase(),f=RegExp($.ui.autocomplete.escapeRegex(d),"i");a=$.grep(a,function(a){a=a.label||a.value||a;return f.test(a)||f.test(pe.normalize(a))});var e=RegExp("^"+$.ui.autocomplete.escapeRegex(d),"i");a=_.sortBy(a,function(a){a=pe.normalize(a.label).toLowerCase();return[a!=d,!e.test(a)]});b(a)};
pe.GeneralAutocompleteInputModule.prototype.clear_selected_data=function(){this.selected_data_list_div.html("");this.add_dummy_row()};pe.GeneralAutocompleteInputModule.prototype.close_button_clicked=function(){this.is_empty()&&this.add_dummy_row();this.fire_event(pe.GeneralAutocompleteInputModule.events.REMOVED);this.is_empty()&&this.fire_event(pe.GeneralAutocompleteInputModule.events.EMPTIED)};pe.GeneralAutocompleteInputModule.prototype.display_close_button=function(){this.selected_data_list_div.find(".CloseButton").show()};
pe.GeneralAutocompleteInputModule.prototype.hide_close_button=function(){this.selected_data_list_div.find(".CloseButton").hide()};pe.GeneralAutocompleteInputModule.prototype.html=function(){return'<input class="AutocompleteField" type="text"><input class="DummyInputField" type="hidden" name="'+this.input_field_name+'" value="x_mock_single_value_x"><ul class="SelectedDataList" id="sortable"></ul>'};pe.GeneralAutocompleteInputModule.prototype.is_empty=function(){return 0===this.selected_data_list_div.find(".SelectedInputData").length};
pe.GeneralAutocompleteInputModule.prototype.remove_dummy_row=function(){this.dummy_input_field&&(this.dummy_input_field.remove(),this.dummy_input_field=null)};pe.GeneralAutocompleteInputModule.prototype.replace_data_in_list=function(a){a&&(this.clear_selected_data(),this.add_data_to_list(a))};
pe.GeneralAutocompleteInputModule.prototype.selected_data_html=function(a,c,b){return'<li class="SelectedInputData">  <img style="padding-right:20px; width: 15px; height: 15px;" src="/assets/events/close.png"\t\tclass="CloseButton float_left">  <p class="float_left">'+(b?a+"("+b+")":a)+'</p>  <input type="hidden" value="'+c+'" name="'+this.input_field_name+'">  <div class="clear"></div></li>'};
pe.ConfirmationDialog=function(a,c){pe.init_widget(this,null);this.success_callback=c;this.container=$(this.html(a));this.container.appendTo("body");var b=this.callback(this.confirm_clicked);this.container.dialog({title:"Please confirm",modal:!0,resizable:!1,width:300,buttons:{Yes:b,Cancel:function(){$(this).remove()}}})};pe.ConfirmationDialog.prototype.html=function(a){return"<div>"+a+"</div>"};pe.ConfirmationDialog.prototype.confirm_clicked=function(){this.success_callback();this.container.remove()};
pe.SortableAutocomplete=function(a,c,b,d,f){pe.init_widget(this,a);this.autocomplete_data_or_url=c;this.limit=d;this.input_field_name=b;this.container.html(this.html());this.dummy_input_field=this.container.find(".DummyInputField");this.messaging_area=this.container.find(".Messaging");this.autocomplete_input_field=this.container.find(".AutocompleteField");a=this.autocomplete_input_field.autocomplete({source:this.autocomplete_data_or_url,minLength:1,close:this.callback(this.autocomplete_closed),select:this.callback(this.autocomplete_entry_selected)}).data("autocomplete");
a._renderItem=pe.SortableAutocomplete.render_autocomplete_entry;a._renderMenu=pe.SortableAutocomplete.render_autocomplete_list;this.selected_data_list_div=this.container.find(".SelectedDataList");this.selected_data_list_div.sortable();this.selected_data_list_div.disableSelection();f&&this.add_data_to_list(f)};pe.SortableAutocomplete.events={SELECTED:"SortableAutocomplete_SELECTED"};
pe.SortableAutocomplete.prototype.add_data_to_list=function(a){0!==a.length&&(this.remove_dummy_row(),$.each(a,this.callback(function(a,b){this.add_selected_data(b.label,b.id,b.category)})),this.enforce_limit())};pe.SortableAutocomplete.prototype.add_dummy_row=function(){this.dummy_input_field||(this.dummy_input_field=$('<input class="DummyInputField" type="hidden" name="'+this.input_field_name+'" value="">'),this.autocomplete_input_field.after(this.dummy_input_field))};
pe.SortableAutocomplete.prototype.add_selected_data=function(a,c,b){this.remove_dummy_row();this.selected_data_list_div.append(this.selected_data_html(a,c,b));(new pe.CloseButton(this.selected_data_list_div.find(".SelectedInputData").last(),pe.CloseButton.close_methods.REMOVE)).bind_event(pe.CloseButton.events.CLOSED,this.callback(this.close_button_clicked));this.enforce_limit()};pe.SortableAutocomplete.prototype.autocomplete_closed=function(){this.autocomplete_input_field.val("")};
pe.SortableAutocomplete.prototype.autocomplete_entry_selected=function(a,c){var b=c.item;this.add_selected_data(b.label,b.id,b.category);this.fire_event(pe.SortableAutocomplete.events.SELECTED,b.id)};pe.SortableAutocomplete.prototype.close_button_clicked=function(){0===this.selected_data_list_div.find(".SelectedInputData").length&&this.add_dummy_row();this.enforce_limit()};
pe.SortableAutocomplete.prototype.enforce_limit=function(){this.selected_data_list_div.find(".SelectedInputData").length>=this.limit?(this.messaging_area.html("You have reached the selection limit. Please remove before adding."),this.autocomplete_input_field.autocomplete("disable")):(this.messaging_area.html(""),this.autocomplete_input_field.autocomplete("enable"))};
pe.SortableAutocomplete.prototype.html=function(){return'<input class="AutocompleteField" type="text"><div class="Messaging"></div><input class="DummyInputField" type="hidden" name="'+this.input_field_name+'" value=""><ul class="SelectedDataList" id="sortable"></ul>'};pe.SortableAutocomplete.prototype.remove_dummy_row=function(){this.dummy_input_field&&(this.dummy_input_field.remove(),this.dummy_input_field=null)};
pe.SortableAutocomplete.render_autocomplete_entry=function(a,c){c.display_label=c.category?pe.templatize("{{label}} ({{category}})",c):c.label;var b=$(pe.templatize("<li><a>{{display_label}}</a></li>",c));b.data("item.autocomplete",c);a.append(b);return b};pe.SortableAutocomplete.render_autocomplete_list=function(a,c){var b=this,d="";$.each(c,function(c,e){e.type!=d&&(a.append("<li class='ui-autocomplete-category  first_category'>"+e.type+"</li>"),d=e.type);b._renderItem(a,e)})};
pe.SortableAutocomplete.prototype.selected_data_html=function(a,c,b){return'<li class="SelectedInputData ui-state-default"><img style="margin-right:20px; width: 15px; height: 15px;" src="/assets/events/close.png"class="CloseButton float_left"><p class="float_left">'+(b?a+"("+b+")":a)+'</p><input type="hidden" value="'+c+'" name="'+this.input_field_name+'"><div class="clear"></div></li>'};
$(document).ready(function(){pe.ajax_loader.tags.load(function(a){new pe.SortableAutocomplete($(".TagSelector"),a,"endpoint[ordered_tag_ids][]",1E4,window.existing_tags)});pe.init_page_framework()});
