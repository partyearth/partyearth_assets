pe.CallbackHandler=function(){this.callbacks={}};pe.CallbackHandler.prototype.add=function(a,b){this.callbacks[a]||(this.callbacks[a]=[]);this.callbacks[a].push(b)};pe.CallbackHandler.prototype.call=function(a,b){var c=Array.prototype.slice.call(arguments,1);if(this.callbacks[a])return _.each(this.callbacks[a],function(a){a.apply(null,c)}),!0};
pe.TabsSection=function(a,b){pe.init_widget(this,a);this.selected_tab="";this.tabs=this.container.find("a[rel]");this.tabs.click(this.callback(this.tab_clicked));this.select_tab(b||"all_results")};pe.TabsSection.events={CHANGED:"TabsSection_CHANGED"};pe.TabsSection.tabs={ALL_RESULTS:"all_results",THINGS_TO_DO:"things_to_do",BARS_AND_CLUBS:"bars_and_clubs",RESTAURANTS:"restaurants",EVENT_VENUES:"event_venues",EVENTS:"events",ENTERTAINERS:"entertainers",TEAMS:"teams"};
pe.TabsSection.venue_tabs={ALL_RESULTS:"all_results",THINGS_TO_DO:"things_to_do",BARS_AND_CLUBS:"bars_and_clubs",RESTAURANTS:"restaurants",EVENT_VENUES:"event_venues"};pe.TabsSection.tab_names=_.uniq(_.values(pe.TabsSection.tabs));pe.TabsSection.prototype.add_search_configuration=function(a){a.add_filter("category",this.get_selected_tab_name())};pe.TabsSection.prototype.get_selected_tab_name=function(){return this.selected_tab};
pe.TabsSection.prototype.read_search_configuration=function(a){this.select_tab(a.filter_value("category")||"all_results")};pe.TabsSection.prototype.select_tab=function(a){a=(a||"").replace(/-/g,"_");_.contains(pe.TabsSection.tab_names,a)||(a="all_results");this.selected_tab=a;this.tabs.removeClass("selected");this.tabs.filter("[rel="+a+"]").addClass("selected")};
pe.TabsSection.prototype.tab_clicked=function(a){a=$(a.currentTarget);a.hasClass("disabled")||(a=a.attr("rel")+"",this.selected_tab!=a&&(this.select_tab(a),pe.fire_global_event(pe.TabsSection.events.CHANGED,a)))};pe.TabsSection.prototype.update_tab_counters=function(a){this.tabs.addClass("disabled");_.each(pe.TabsSection.tab_names,this.callback(function(b){var c=this.tabs.filter("[rel="+b+"]"),b=a[b]||0;0!==b&&c.removeClass("disabled");c.find(".Counter").html("("+b+")")}))};
pe.StandardFilter=function(a,b,c,d){pe.init_widget(this,a);this.id=b;this.title=d||this.id;this.facets={};this.selection_facets={};this.selected_values=[];this.visible_tabs=c;this.callbacks=new pe.CallbackHandler;this.all_container=a.find(".All");this.all_container.addClass("hidden");setTimeout(this.callback(function(){this.all_container.treeview({collapsed:!0})}),0);this.summary_container=a.find(".Summary");this.more_link=this.container.find(".More");this.more_link.click(this.callback(this.on_more_link_clicked));
this.filter_title_container=this.container.find(".FilterTitle");this.filter_title_container.click(this.callback(this.on_more_link_clicked));this.view_status=pe.StandardFilter.view_statuses.SUMMARY;this.all_inputs().live("change",this.callback(this.on_checkbox_changed));this.summary_inputs().live("change",this.callback(this.on_checkbox_changed));pe.bind_global_event(pe.TabsSection.events.CHANGED,this.callback(this.on_tab_changed))};pe.StandardFilter.SUMMARY_LENGTH=4;
pe.StandardFilter.callbacks={AFTER_CHECKBOX_CHANGED:"standard_filter_after_checkbox_changed",AFTER_UPDATE_SUMMARY:"after_update_summary",BEFORE_UPDATE_SUMMARY:"before_update_summary"};pe.StandardFilter.events={CHANGED:"StandardFilter_CHANGED"};pe.StandardFilter.view_statuses={HIDDEN:1,SUMMARY:2,ALL:3};pe.StandardFilter.prototype.add_search_configuration=function(a){a.filter_value("result_types");!this.is_nothing_checked()&&!this.is_all_checked()&&a.add_filter(this.id,this.filter_values())};
pe.StandardFilter.prototype.filter_values=function(){return _.union(_.map(this.selected_values,function(a){return this.input_value(a)},this))};pe.StandardFilter.prototype.input_value=function(a){var b=[a],a=$("#tag_"+a).parents("ul").parents("li").children(".Input");0<a.length&&(b=b.concat(this.input_value("__parent_tag__"+a.val())));return b};pe.StandardFilter.prototype.all_inputs=function(){return this.all_container.find(".Input")};pe.StandardFilter.prototype.summary_inputs=function(){return this.summary_container.find(".Input")};
pe.StandardFilter.prototype.select=function(a){this.selected_values=_.union(this.selected_values,a)};pe.StandardFilter.prototype.unselect=function(a){this.selected_values=_.without(this.selected_values,a)};pe.StandardFilter.prototype.is_selected=function(a){return _.include(this.selected_values,a)};pe.StandardFilter.prototype.check=function(a){this.select(a);$("#tag_"+a).attr("checked","checked");$("#summary_tag_"+a).attr("checked","checked")};
pe.StandardFilter.prototype.fix_tree_expander=function(){_.each(this.all_container.find("li:not(.Custom,.hidden)"),function(a){var b=$(a).find("li");0!==b.length&&(0===b.filter("li:not(.hidden)").length?$(a).removeClass("collapsable expandable").children(".expandable-hitarea").hide():$(a).hasClass("expandable")||$(a).addClass("expandable").children(".expandable-hitarea").show())})};pe.StandardFilter.prototype.get_filter_field=function(a){return $("#tag_"+a).closest("li")};
pe.StandardFilter.prototype.get_visible_tabs=function(){return this.visible_tabs};pe.StandardFilter.prototype.is_all_checked=function(){return this.all_inputs().length===this.selected_values.length};pe.StandardFilter.prototype.is_any_checked=function(){return 0<this.selected_values.length};pe.StandardFilter.prototype.is_many_items_checked=function(){return 1<this.selected_values.length};pe.StandardFilter.prototype.is_only_one_item_checked=function(){return 1===this.selected_values.length};
pe.StandardFilter.prototype.is_checked=function(a){return _.include(this.selected_values,a)};pe.StandardFilter.prototype.is_nothing_checked=function(){return 0===this.selected_values.length};
pe.StandardFilter.prototype.on_checkbox_changed=function(a){var a=$(a.target).closest(".Input"),b=a.val().toString();this.is_selected(b)?this.uncheck(b):this.check(b);pe.fire_global_event(pe.StandardFilter.events.CHANGED);setTimeout(this.callback(function(){this.update_summary()}),1);this.callbacks.call(pe.StandardFilter.callbacks.AFTER_CHECKBOX_CHANGED,a)};
pe.StandardFilter.prototype.on_dialog_close_button_clicked=function(){this.all_container.dialog("destroy");this.all_container.addClass("hidden");this.view_status=pe.StandardFilter.view_statuses.SUMMARY};
pe.StandardFilter.prototype.on_more_link_clicked=function(){this.all_container.removeClass("hidden");var a=this.all_container.dialog({title:this.title,modal:!0,resizable:!1,buttons:{Close:this.callback(this.on_dialog_close_button_clicked)}});a.parent().css({position:"fixed"}).end();a.find(".Input").unbind("change").bind("change",this.callback(this.on_checkbox_changed));this.view_status=pe.StandardFilter.view_statuses.ALL};
pe.StandardFilter.prototype.on_tab_changed=function(a,b){_.include(this.visible_tabs,b)?this.show():this.hide()};pe.StandardFilter.prototype.read_search_configuration=function(a){this.selected_values=_.compact(_.union([],a.filter_value(this.id)));this.selected_values=_.reject(this.selected_values,function(a){return a.match(/^__parent_tag__/g)});_.each(this.selected_values,function(a){this.check(a)},this);this.update_summary()};pe.StandardFilter.prototype.replace_filter_field=function(a,b){this.get_filter_field(a).html(b)};
pe.StandardFilter.prototype.reset=function(){_.each(this.selected_values,function(a){this.uncheck(a)},this);setTimeout(this.callback(function(){this.update_summary()}),1)};pe.StandardFilter.prototype.uncheck=function(a){this.unselect(a);$("#tag_"+a).removeAttr("checked");$("#summary_tag_"+a).removeAttr("checked")};
pe.StandardFilter.prototype.update_more_button=function(){var a=this.all_container.find(".Top:not(.hidden)");a.length>pe.StandardFilter.SUMMARY_LENGTH||0<a.find(".Child").length?(this.more_link.removeClass("hidden"),this.filter_title_container.removeClass("no_hover"),this.filter_title_container.click(this.callback(this.on_more_link_clicked))):(this.more_link.addClass("hidden"),this.filter_title_container.addClass("no_hover").unbind("click"))};
pe.StandardFilter.prototype.update_ui=function(){0<this.all_container.find(">.Top:not(.hidden)").length?(this.fix_tree_expander(),this.update_summary()):this.hide()};pe.StandardFilter.prototype.free_summary_slots=function(){return pe.StandardFilter.SUMMARY_LENGTH-this.summary_container.children("li").length};
pe.StandardFilter.prototype.update_summary=function(){this.summary_container.empty();this.callbacks.call(pe.StandardFilter.callbacks.BEFORE_UPDATE_SUMMARY);var a=_.first(this.selected_values,this.free_summary_slots());this.add_tags_to_summary(a);var b=this.free_summary_slots();if(0<b)for(var a=_.map(_.difference(this.top_tags(),a),function(a){return $("#tag_"+a)}),c=0;0<b&&c<a.length;c++){var d=a[c].parent().filter("li.Top:not(.Custom)");0<d.length&&(this.add_items_to_summary(d.clone()),b--)}this.update_more_button();
this.callbacks.call(pe.StandardFilter.callbacks.AFTER_UPDATE_SUMMARY)};pe.StandardFilter.prototype.top_tags=function(){var a=_.sortBy(_.values(this.selection_facets),function(a){return 1E4-a},this),a=_.compact(_.union(_.map(a,function(a){return _.map(this.selection_facets,function(b,e){if(b==a)return e})},this))),b=_.difference(_.keys(this.facets),a);return _.union(a,b)};
pe.StandardFilter.prototype.set_facets=function(a){this.facets=a;this.all_container.find("li:not(.Custom)").addClass("hidden");_.each(_.keys(this.facets),function(a){this.get_filter_field(a).removeClass("hidden")},this);_.each(this.selected_values,function(a){this.get_filter_field(a).removeClass("hidden")},this)};pe.StandardFilter.prototype.set_selection_facets=function(a){this.selection_facets=a;setTimeout(this.callback(function(){this.update_ui()}),1)};
pe.StandardFilter.prototype.add_tags_to_summary=function(a){_.each(a,function(a){a=$("#tag_"+a).parent("li").clone();a.hasClass("Custom")||this.summary_container.append(this.convert_to_summary_item(a,!0))},this)};pe.StandardFilter.prototype.add_items_to_summary=function(a){_.each(a,function(a){this.summary_container.append(this.convert_to_summary_item($(a),!0))},this)};
pe.StandardFilter.prototype.convert_to_summary_item=function(a,b){var c=a.find(".Input"),d="summary_"+c.attr("id");c.attr("id",d);a.find("label").attr("for",d);b&&a.find("ul").remove();return a};
