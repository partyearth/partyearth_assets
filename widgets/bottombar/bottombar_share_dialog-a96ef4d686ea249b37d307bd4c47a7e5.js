pe.CloseButton=function(a,b){pe.init_widget(this,a);this.close_button=a.find(".CloseButton");if("function"===typeof b)this.close_button.click(b);else switch(b){case pe.CloseButton.close_methods.REMOVE:this.close_button.click(this.callback(this.remove_container));break;case pe.CloseButton.close_methods.HIDE:this.close_button.click(this.callback(this.hide_container));break;default:alert("unknown value for 'close_method' parameter.")}};pe.CloseButton.close_methods={REMOVE:"REMOVE",HIDE:"HIDE"};
pe.CloseButton.events={CLOSED:"CloseButton_CLOSED"};pe.CloseButton.prototype.remove_container=function(){this.container.detach();this.fire_event(pe.CloseButton.events.CLOSED);this.container.remove();return!1};pe.CloseButton.prototype.hide_container=function(){this.fire_event(pe.CloseButton.events.CLOSED);this.container.hide();return!1};
pe.BottombarPopupModule=function(a,b,c,d,e,f){pe.BottombarPopupModule.active_popup&&pe.BottombarPopupModule.active_popup.close();a.append(this.html(b,e,f));pe.init_widget(this,a.find("."+b));this.container.attr("height",d);this.container.attr("width",c);this.parent_container=a;a=this.parent_container.attr("title");this.parent_container_link_title="string"===typeof a?a:"";this.form_container=this.container.find(".FormContainer");pe.BottombarPopupModule.active_popup=this;this.close_button=new pe.CloseButton(this.container,
pe.CloseButton.close_methods.REMOVE);this.close_button.bind_event(pe.CloseButton.events.CLOSED,this.callback(this.closed));this.container.hover(this.callback(this.mouse_enter),this.callback(this.mouse_leave));this.container.click(this.callback(this.popup_element_clicked))};pe.BottombarPopupModule.prototype.html=function(a,b,c){return'<div class="'+a+'">  <div class="CloseButton fake_link"></div>  <div class="title headline">'+b+'</div>  <div class="FormContainer">'+c+'</div>  <div class="bottom_arrow"></div></div>'};
pe.BottombarPopupModule.prototype.closed=function(){pe.BottombarPopupModule.active_popup&&pe.BottombarPopupModule.active_popup.mouse_leave();pe.BottombarPopupModule.active_popup=null};pe.BottombarPopupModule.prototype.close=function(){this.close_button.remove_container();this.closed();return!1};pe.BottombarPopupModule.prototype.mouse_enter=function(){this.parent_container.attr("title","")};pe.BottombarPopupModule.prototype.mouse_leave=function(){this.parent_container.attr("title",this.parent_container_link_title)};
pe.BottombarPopupModule.prototype.show_thank_you=function(a){this.form_container.html(this.thank_you_html(a))};pe.BottombarPopupModule.prototype.thank_you_html=function(a){return"<div>  <p>"+a+"</p></div>"};pe.BottombarPopupModule.prototype.popup_element_clicked=function(a){a.stopPropagation()};pe.validation={};pe.validatables=[];pe.validation.autocomplete_open=!1;pe.validate_on_key_up=function(a,b){a.keyup(function(){b(a)});a.val()&&b(a);return a};
pe.validate_on_blur=function(a,b,c){a.blur(function(){b(a)});!c&&a.val()&&b(a);return a};pe.validate_on_change=function(a,b,c){a.change(function(){b(a)});!c&&a.val()&&b(a);return a};
pe.validate_before_submit=function(a){a.submit(function(){pe.validation.clear_error_messages(a);a.find("input").each(function(a,b){var c=$(b);c.data("text_entered",!0);c.keyup();c.blur()});a.find("select").each(function(a,b){var c=$(b);c.data("text_entered",!0);c.change()});a.find("textarea").each(function(a,b){var c=$(b);c.data("text_entered",!0);c.keyup();c.blur()});var b=!0;$.each(pe.validatables,function(a,c){b=c.validate_on_submit()&&b});if(0<a.find(".inline-errors").length||!b){var c=a.find(".inline-errors:first").parent(),
d=c.find("input:first");0<d.length?d.is(":hidden")?(d.show(),d.focus(),d.hide()):d.focus():(d=c.find("textarea"),c=c.find('select option:selected[value=""]').parent(),d&&d.focus(),c&&c.focus());return!1}})};
pe.validate_user_exists=function(a,b){form=$(a.parents("form")[0]);form.submit(function(){pe.validation.clear_error_messages(form);$.post("/api/users/check_user_exists",{login:a.val(),password:b.val()},function(c){pe.validation.show_message(a,c.username);pe.validation.show_message(b,c.password);_.isEmpty(c)&&(form.unbind("submit"),form.submit())});return!1})};pe.validation.clear_error_messages=function(a){pe.validation.find_error_messages(a).remove()};pe.validation.find_error_messages=function(a){return a.find(".inline-errors")};
pe.validation.show_message=function(a,b){a.parent().find(".inline-errors,img").remove();b?a.after('<span class="inline-errors">'+b+"</span>"):a.after('<img src="/assets/users/check.png" />')};pe.validation.is_more_than_5_words=function(a){return!!a.match(/(\w+\s+){5}\w+/)};pe.validation.is_single_non_character=function(a){return!a?!1:!a.match(/[a-zA-Z]+/)};pe.validation.is_valid_email_address=function(a){return!!a.match(/^([A-Za-z0-9_\-\.])+\@([A-Za-z0-9])([A-Za-z0-9_\-\.])*\.([A-Za-z]{2,4})$/)};
pe.validation.is_valid_email_list=function(a){if(!a)return"Please enter at least one email.";var a=a.split(","),b="";$.each(a,function(a,d){d=$.trim(d);if(!pe.validation.is_valid_email_address(d))return b=d+" is not a valid email address.",!1});return b};pe.validation.contains_illegal_characters=function(a){return!!a.match(/[\!@#\$%\^&\*\(\)\{\}\[\]\/\=\"<>\~\;_\+\?\\]/)};
pe.validation.ensure_email_not_blank_and_is_valid=function(a){var b=a.val();if(!("string"!==typeof b||!b&&!a.data("text_entered"))){a.data("text_entered",!0);var c=a.attr("data_label")||"Email";if(0===b.length)pe.validation.show_message(a,c+" cannot be blank.");else{var d=!0,e=/^([A-Za-z0-9_\-\.])+\@([A-Za-z0-9])([A-Za-z0-9_\-\.])*\.([A-Za-z]{2,4})$/;$.each(b.split(","),function(a,b){d=d&&0<b.length&&e.test($.trim(b))});d?(pe.validation.show_message(a,""),a.data("text_entered",!0)):pe.validation.show_message(a,
"Please enter a valid email.")}}};
pe.validation.validate_name=function(a){var b=a.val();"string"!==typeof b||!b&&!a.data("text_entered")||(a.data("text_entered",!0),pe.validation.is_single_non_character(b)?pe.validation.show_message(a,"Please enter a valid "+pe.validation.get_name_error_message(a)+"."):pe.validation.contains_illegal_characters(b)?pe.validation.show_message(a,"Please enter a valid name."):50<b.length?pe.validation.show_message(a,"Please shorten your name."):pe.validation.is_more_than_5_words(b)?pe.validation.show_message(a,
"Please enter fewer than 5 words."):0<b.length?pe.validation.show_message(a,""):0<a[0].id.indexOf("first_name")?pe.validation.show_message(a,"Please enter your first name."):0<a[0].id.indexOf("last_name")?pe.validation.show_message(a,"Please enter your last name."):pe.validation.show_message(a,"Please enter your name."))};
pe.validation.ensure_not_blank=function(a){var b=a.val();"string"!==typeof b||!b&&!a.data("text_entered")||(a.data("text_entered",!0),0===a.val().length?(b=a.attr("data_label")||"Field",pe.validation.show_message(a,b+" cannot be blank.")):(pe.validation.show_message(a,""),a.data("text_entered",!0)))};
pe.validation.validate_credit_card_number=function(a){var b=a.val();if(!(16>b.length)||a.data("text_entered"))a.data("text_entered",!0),"string"===typeof b&&pe.is_valid_credit_card_number(b)?pe.validation.show_message(a,""):pe.validation.show_message(a,"Please enter a valid card number.")};pe.validation.validate_email=function(a){var b=a.val();if(b||a.data("text_entered"))a.data("text_entered",!0),$.getJSON("/api/users/check_email",{email:b},function(b){pe.validation.show_message(a,b.message)})};
pe.validation.validate_edited_email=function(a,b){var c=b.val();if(c||b.data("text_entered"))b.data("text_entered",!0),$.getJSON("/api/users/"+a+"/check_edited_email",{email:c},function(a){pe.validation.show_message(b,a.message)})};
pe.validation.validate_email_format=function(a){var b=a.val(),c=/^([A-Za-z0-9_\-\.])+\@([A-Za-z0-9])([A-Za-z0-9_\-\.])*\.([A-Za-z]{2,4})$/;0<b.length&&!c.test(b)?pe.validation.show_message(a,"Please enter a valid email."):0<b.length&&c.test(b)&&(pe.validation.show_message(a,""),a.data("text_entered",!0))};pe.validation.validate_email_list=function(a){var b=a.val();"string"===typeof b&&(b=pe.validation.is_valid_email_list(b))&&pe.validation.show_message(a,b)};
pe.validation.validate_password=function(a){var b=a.val();b?0<b.length&&-1<b.indexOf(" ")?pe.validation.show_message(a,"No spaces allowed for password."):6>b.length?pe.validation.show_message(a,"Please enter a longer password."):(pe.validation.show_message(a,""),a.data("text_entered",!0)):a.data("text_entered")&&pe.validation.show_message(a,"Please enter a password.")};
pe.validation.validate_security_code=function(a){var b=a.val();if(!(3>b.length)||a.data("text_entered"))a.data("text_entered",!0),b.match(/^\d{3}$/)||pe.validation.show_message(a,"Please enter a valid security code.")};
pe.validation.validate_user_name=function(a){var b=a.val();a.attr("disabled")||!b&&!a.data("text_entered")||(a.data("text_entered",!0),50<b.length?pe.validation.show_message(a,"Please shorten your name."):0===b.length?pe.validation.show_message(a,"Please enter a user name."):$.getJSON("/api/users/check_username",{username:b},function(b){pe.validation.show_message(a,b.message)}))};
pe.validation.validate_change_of_username=function(a,b){var c=b.val();if(c||b.data("text_entered"))b.data("text_entered",!0),50<c.length?pe.validation.show_message(b,"Please shorten your name."):0===c.length?pe.validation.show_message(b,"Please enter a user name."):$.getJSON("/api/users/"+a+"/check_edited_username",{username:c},function(a){pe.validation.show_message(b,a.message)})};
pe.validation.validate_zip_code=function(a){var b=a.val();if(!(5>b.length)||a.data("text_entered"))a.data("text_entered",!0),5>b.length?pe.validation.show_message(a,"Please enter a valid zip code."):"string"===typeof b&&pe.is_valid_zip_code(b)?pe.validation.show_message(a,""):pe.validation.show_message(a,"Please enter a valid zip code.")};
pe.validation.terms_accepted=function(a){if(a.attr("checked")||a.data("text_entered"))a.data("text_entered",!0),a.attr("checked")?pe.validation.show_message(a.parent(),""):pe.validation.show_message(a.parent(),"Please accept the terms of use")};pe.validation.get_name_error_message=function(a){return 0<a[0].id.indexOf("first_name")?"first name":0<a[0].id.indexOf("last_name")?"last name":"name"};
pe.BottombarShareDialog=function(a,b){pe.init_widget(this,a);pe.BottombarPopupModule.active_popup&&pe.BottombarPopupModule.active_popup.close();pe.BottombarPopupModule.active_popup=this;this.parent_container=this.container;this.url=b||window.location.href;this.dialog_box=$('<div title="Share this page with your friends"></div>');this.dialog_box.html(this.html());this.name_input=this.dialog_box.find(".Name");this.email_input=this.dialog_box.find(".Emails");pe.validate_on_blur(this.email_input,pe.validation.ensure_email_not_blank_and_is_valid);
this.message_input=this.dialog_box.find(".MessageInput");this.cancel_button=this.dialog_box.find(".CancelButton");this.cancel_button.click(this.callback(this.close));this.submit_button=this.dialog_box.find(".SubmitButton");this.submit_button.click(this.callback(this.submit_button_clicked));this.dialog_box.dialog({modal:!0,show:!1,close:this.callback(this.close)})};
pe.BottombarShareDialog.prototype.close=function(){this.dialog_box.empty();this.dialog_box.dialog("destroy");pe.BottombarPopupModule.active_popup=null};pe.BottombarShareDialog.prototype.html=function(){return'<div class="share_form_container"><div class="field_item"><label for="your_name">Your Name</label><input id="your_name" class="Name" type="text"></div><div class="field_item"><label for="friend_email">Friends\' Email(s) <span class="blue_text">*</span><br><span class="grey_text">separated by<br> commas</span></label><textarea id="friend_email" data_label="Email(s)" class="Emails friends_emails_input"></textarea></div><div class="field_item"><label for="message">Message</label><textarea id="message" class="MessageInput message_input"></textarea></div><div class="clear"></div><div class="CancelButton hidden">Cancel</div><div class="SubmitButton submit_btn blue_btn float_right">OK</div></div>'};
pe.BottombarShareDialog.prototype.submit_button_clicked=function(){if(this.validate_on_submit())$.ajax({url:"/api/email_page_to_friend.json",data:{name:this.name_input.val(),emails:this.email_input.val(),url:this.url,message:this.message_input.val()},type:"POST",success:this.callback(function(a){this.form_submitted(a)})});else return!1};
pe.BottombarShareDialog.prototype.form_submitted=function(a){if(1===a.message)this.show_thank_you();else return this.submit_button.before('<p class="inline-errors">'+a.message+"</p>"),!1};pe.BottombarShareDialog.prototype.show_thank_you=function(){this.dialog_box.html("<div><p>Thank You</p></div>")};pe.BottombarShareDialog.prototype.validate_on_submit=function(){pe.validation.clear_error_messages(this.dialog_box);this.email_input.data("text_entered",!0).blur();return 0===this.dialog_box.find(".inline-errors").length};
