pe.CloseButton=function(b,a){pe.init_widget(this,b);this.close_button=b.find(".CloseButton");if("function"===typeof a)this.close_button.click(a);else switch(a){case pe.CloseButton.close_methods.REMOVE:this.close_button.click(this.callback(this.remove_container));break;case pe.CloseButton.close_methods.HIDE:this.close_button.click(this.callback(this.hide_container));break;default:alert("unknown value for 'close_method' parameter.")}};pe.CloseButton.close_methods={REMOVE:"REMOVE",HIDE:"HIDE"};
pe.CloseButton.events={CLOSED:"CloseButton_CLOSED"};pe.CloseButton.prototype.remove_container=function(){this.container.detach();this.fire_event(pe.CloseButton.events.CLOSED);this.container.remove();return!1};pe.CloseButton.prototype.hide_container=function(){this.fire_event(pe.CloseButton.events.CLOSED);this.container.hide();return!1};
pe.SingleSelectionAutocompleteField=function(b,a,e,g){pe.init_widget(this,b);this.close_button_callback=this.on_item_selected=null;this.autocomplete_data_or_url=a;this.input_field_name=e;this.container.html(this.html());this.dummy_input_field=this.container.find(".DummyInputField");this.autocomplete_input_field=this.container.find(".AutocompleteField");this.autocomplete_handler();this.selected_data_container=this.container.find(".SelectedValue");g&&this.set_field_value(g)};
pe.SingleSelectionAutocompleteField.events={SELECTED:"SingleSelectionAutocompleteField_SELECTED"};pe.SingleSelectionAutocompleteField.prototype.set_autocomplete_url=function(b){b&&(this.autocomplete_data_or_url=b,this.autocomplete_handler())};pe.SingleSelectionAutocompleteField.prototype.set_field_value=function(b){b&&(this.remove_dummy_row(),this.autocomplete_data_selected(b))};
pe.SingleSelectionAutocompleteField.prototype.add_dummy_row=function(){this.dummy_input_field||(this.dummy_input_field=$('<input class="DummyInputField"        type="hidden" name="'+this.input_field_name+'"       value="x_mock_single_value_x">'),this.autocomplete_input_field.after(this.dummy_input_field))};
pe.SingleSelectionAutocompleteField.prototype.autocomplete_data_selected=function(b){this.selected_data=b;this.remove_dummy_row();this.selected_data_container.append(this.selected_data_html(b.label,b.id,b.category));(new pe.CloseButton(this.selected_data_container.find(".SelectedInputData").last(),pe.CloseButton.close_methods.REMOVE)).bind_event(pe.CloseButton.events.CLOSED,this.callback(this.close_button_clicked));if(this.on_item_selected)this.on_item_selected(b)};
pe.SingleSelectionAutocompleteField.prototype.item_selected=function(b){this.on_item_selected=b};
pe.SingleSelectionAutocompleteField.prototype.autocomplete_handler=function(){this.autocomplete_input_field.autocomplete({source:this.autocomplete_data_or_url,minLength:1,close:this.callback(function(){this.autocomplete_input_field.val("")}),select:this.callback(function(b,a){var e=a.item;this.autocomplete_data_selected(e);this.fire_event(pe.SingleSelectionAutocompleteField.events.SELECTED,e.id)})}).data("autocomplete")._renderItem=function(b,a){a.display_label=a.category?pe.templatize("{{label}} ({{category}})",
a):a.label;return $("<li></li>").data("item.autocomplete",a).append(pe.templatize("<a>{{display_label}}</a>",a)).appendTo(b)}};pe.SingleSelectionAutocompleteField.prototype.clear_selected_data=function(){this.selected_data_container.html("");this.add_dummy_row()};
pe.SingleSelectionAutocompleteField.prototype.close_button_clicked=function(){0===this.selected_data_container.find(".SelectedInputData").length&&this.add_dummy_row();this.close_button_callback&&this.close_button_callback();this.autocomplete_input_field.show();this.autocomplete_input_field.focus()};pe.SingleSelectionAutocompleteField.prototype.display_close_button=function(){this.selected_data_container.find(".CloseButton").show()};pe.SingleSelectionAutocompleteField.prototype.hide_close_button=function(){this.selected_data_container.find(".CloseButton").hide()};
pe.SingleSelectionAutocompleteField.prototype.html=function(){return'<input class="AutocompleteField" type="text"><input class="DummyInputField" type="hidden" name="'+this.input_field_name+'" value="x_mock_single_value_x"><div class="SelectedValue"></div>'};pe.SingleSelectionAutocompleteField.prototype.remove_dummy_row=function(){this.dummy_input_field&&(this.dummy_input_field.remove(),this.dummy_input_field=null)};
pe.SingleSelectionAutocompleteField.prototype.replace_data_in_list=function(b){this.clear_selected_data();this.set_field_value(b)};pe.SingleSelectionAutocompleteField.prototype.selected_data_html=function(b,a,e){return'<div class="SelectedInputData selected_data">  <div class="CloseButton close_button">'+(e?b+"("+e+")":b)+'</div>  <input type="hidden" value="'+a+'" name="'+this.input_field_name+'"></div>'};
(function(){var b=function(a,e){return function(){return a.apply(e,arguments)}};pe.BulkPhotoTool=function(){function a(a){this.container=a;this.window_unloaded=b(this.window_unloaded,this);this.uncheck_all_clicked=b(this.uncheck_all_clicked,this);this.refresh_hidden_input=b(this.refresh_hidden_input,this);this.delete_link_clicked=b(this.delete_link_clicked,this);this.check_all_clicked=b(this.check_all_clicked,this);this.checkbox_clicked=b(this.checkbox_clicked,this);this.autocomplete_type_changed=
b(this.autocomplete_type_changed,this);this.copy_button_clicked=b(this.copy_button_clicked,this);this.move_button_clicked=b(this.move_button_clicked,this);this.sortable_updated=b(this.sortable_updated,this);this.counter_container=$(".CheckedCount");this.check_all_link=$(".CheckAll");this.check_all_link.click(this.check_all_clicked);this.delete_link=$(".DeleteAll");this.delete_link.click(this.delete_link_clicked);this.uncheck_all_link=$(".UncheckAll");this.uncheck_all_link.click(this.uncheck_all_clicked);
this.check_ids(this.load_checked());this.status_changer=$(".StatusChanger");this.status_changer.submit(this.status_submitted);this.autocomplete_type_selector=$("#destination_type");this.autocomplete_type_selector.change(this.autocomplete_type_changed);this.move_button=$(".Move");this.move_button.click(this.move_button_clicked);this.copy_button=$(".Copy");this.copy_button.click(this.copy_button_clicked);this.refresh_counter(this.get_checked().length);this.refresh_hidden_input();$("#sortable").sortable({update:this.sortable_updated});
this.checkboxes().click(this.checkbox_clicked);$(window).unload(this.window_unloaded);this.urls={Article:"/api/articles/autocomplete",Character:"/api/characters/autocomplete",City:"/api/events/cities",Event:"/api/events/autocomplete",Neighborhood:"/api/neighborhoods/autocomplete",Performer:"/api/performers",Tag:"/api/tags",Venue:"/api/venues/autocomplete",Writer:"/api/users/writers_autocomplete"}}a.prototype.sortable_updated=function(a,b){var c,d,f;f=$(b.item);c=this.get_checked();d=f.find("input:checked");
if(0<d.length)return d.removeAttr("checked"),c=this.get_checked(),c=_.map(c,function(a){return $(a).closest("li")}),_.each(c.reverse(),function(a){return f.after($(a))}),d.attr("checked","checked")};a.prototype.bulk_move_copy=function(a){var b,c,d;d=this.extract_ids(this.get_checked());b=$("input[name=imageable_id]").val();c=this.autocomplete_type_selector.val();this.save_checked(this.extract_ids(this.get_checked()));if(confirm("Are you sure?"))return this.notify_users(),$.post(a,{ids:d,dst_id:b,
dst_type:c},function(){return window.location.reload()})};a.prototype.move_button_clicked=function(){return this.bulk_move_copy(window.location.pathname+"/bulk_move")};a.prototype.copy_button_clicked=function(){return this.bulk_move_copy(window.location.pathname+"/bulk_copy")};a.prototype.autocomplete_type_changed=function(){var a;a=this.urls[this.autocomplete_type_selector.val()];return this.autocomplete=new pe.SingleSelectionAutocompleteField($(".DestinationAutocomplete"),a,"imageable_id",[])};
a.prototype.checkbox_clicked=function(a){var b,c,d;b=this.checkboxes().index(a.target);if(a.shiftKey&&this.last_checked)for(a=c=d=this.last_checked;d<=b?c<=b:c>=b;a=d<=b?++c:--c)this.check(this.checkboxes()[a]);this.last_checked=b;this.refresh_counter();return this.refresh_hidden_input()};a.prototype.check_all_clicked=function(){var a,b,c,d;d=this.checkboxes();b=0;for(c=d.length;b<c;b++)a=d[b],this.check(a);this.refresh_counter();return this.refresh_hidden_input()};a.prototype.check_ids=function(a){var b,
c,d,f;f=[];c=0;for(d=a.length;c<d;c++)b=a[c],f.push(this.check("#"+b+"_bulk_photo_checkbox"));return f};a.prototype.check=function(a){return $(a).attr("checked","checked")};a.prototype.delete_link_clicked=function(){var a;a=this.extract_ids(this.get_checked());if(confirm("Are you sure?"))return this.notify_users(),$.post("photos/bulk_delete",{ids:a},function(){return window.location.reload()})};a.prototype.extract_ids=function(a){return _.map(a,function(a){return $(a).data("id")})};a.prototype.checkboxes=
function(){return this.container.find(".BulkCheckbox")};a.prototype.get_checked=function(){return this.checkboxes().filter(":checked")};a.prototype.load_checked=function(){return JSON.parse(localStorage.getItem("pe_bulk_photos_ids"))||[]};a.prototype.notify_users=function(){return $("body").html("<h1>Please wait...</h1>")};a.prototype.refresh_counter=function(){return this.counter_container.html("Photos selected("+this.get_checked().length+")")};a.prototype.refresh_hidden_input=function(){return $("#checked_photos_ids").val(this.extract_ids(this.get_checked()))};
a.prototype.save_checked=function(a){return localStorage.setItem("pe_bulk_photos_ids",JSON.stringify(a))};a.prototype.uncheck_all_clicked=function(){this.checkboxes().removeAttr("checked");this.refresh_counter();return this.refresh_hidden_input()};a.prototype.window_unloaded=function(){return localStorage.clear()};return a}()}).call(this);
