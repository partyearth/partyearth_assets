pe.HelpModule2=function(){var e=$(".HelperModule");e.length&&(pe.init_widget(this,e),this.container.live("click",this.callback(this.helper_module_div_clicked)),this.container.live("hover",this.callback(this.helper_module_div_hovered)),this.active_popup=null)},pe.HelpModule2.prototype.close_button_clicked=function(){this.destroy_active_popup()},pe.HelpModule2.prototype.create_popup=function(e,t){this.active_popup=$(t),e.append(this.active_popup),$("body").bind("click",this.callback(this.close_button_clicked))},pe.HelpModule2.prototype.destroy_active_popup=function(){$("body").unbind("click"),this.active_popup.remove(),this.active_popup=null},pe.HelpModule2.prototype.helper_module_div_hovered=function(e){var t=$(e.target),i=(t.hasClass("HelperModule")?t:t.closest(".HelperModule")).data("page-id");i&&pe.ajax_loader.help_page.load({page_id:i},this.callback(function(){}))},pe.HelpModule2.prototype.helper_module_div_clicked=function(e){var t,i=$(e.target);t=i.hasClass("HelperModule")?i:i.closest(".HelperModule"),this.active_popup&&this.destroy_active_popup();var a=t.data("page-id");a&&pe.ajax_loader.help_page.load({page_id:a},this.callback(function(e){this.create_popup(t,this.popup_html(e))})),e.stopPropagation()},pe.HelpModule2.prototype.popup_html=function(e){return pe.templatize('<div class="DialogBox dialog_box"><div class="dialog_content_wrapper clearfix"><div class="CloseButton close_btn" title="Close"></div><div class="dialog_img"></div><div class="dialog_content"> <span class="title">{{title}}:&nbsp;&nbsp;</span> {{content}}</div></div></div><div class="dialog_point"><div class="dialog_inner_point"></div></div>',e)},pe.PhotoModule=function(e,t,i,a,s,o){pe.init_widget(this,e),this.container.html(this.dom(i)),this.slide_show_div=this.container.find(".SlideShow"),this.slide_show_div.html(this.render_photos(t,a,s,o)),0<t.length&&(this.slide_show_div.addClass("slider"),this.slide_show_div.nivoSlider({effect:"slideInRight",startSlide:0,animSpeed:70,pauseTime:0,directionNav:1<t.length,directionNavHide:!0,controlNav:!1,keyboardNav:!0,manualAdvance:!0}))},pe.PhotoModule.prototype.dom=function(e){return'<div class="SlideShow '+e+'"></div>'},pe.PhotoModule.prototype.render_photos=function(e,a,s,o){var n="";if(0===e.length)n+='<img src="'+pe.https(pe.assign_photo_size("",a,s))+'" alt="" title="">';else{var r=this,p=e.length;$.each(e,function(e,t){t.photo=pe.https(pe.assign_photo_size(t.src,a,s)),t.position=e+1+" of "+p,t.title_div="title_div_"+o+"_"+e,t.photo_caption_container=""===t.title?"":'<div class="photo_caption float_left"><span class="text float_left">'+t.title+'</span><div class="line_divider"></div></div>',r.container.append(pe.templatize('<div id="{{title_div}}" class="nivo-html-caption"><table width="100%" cellpadding="0" cellspacing="0"><tbody><tr><td width="90%">{{photo_caption_container}}</td><td valign="bottom"><div class="photo_number float_right"><span class="text"><nobr>{{position}}</nobr></span><div></td></tr></tbody></table></div>',t));var i='<img src="{{photo}}" alt="" title="#{{title_div}}"/>';t.url?n+=pe.templatize('<a href="{{url}}">'+i+"</a>",t):n+=pe.templatize(i,t)})}return n},pe.map_tools.array_contains_marker=function(e,i){var a=!1;return $.each(e,function(e,t){if(t.object_id===i)return!(a=!0)}),a},pe.map_tools.event_map_data=function(e){var o=[];return $.each(e,function(e,s){$.each(s.locations,function(e,t){if(!t.latitude)return!0;var i=t.name,a=pe.map_tools.find_venue_by_name_in_array(o,i);a||(a={name:i,url:t.url,id:t.id,latitude:t.latitude,longitude:t.longitude,thumbnail:t.photo,small_pin:t.small_pin,ordering:s.ordering,favorite_id:s.favorite_id,city_id:s.city_id,events:[]},o.push(a)),a.events.push(s)})}),o},pe.map_tools.find_marker=function(e,i){var a=null;return $.each(e,function(e,t){if(t.object_id===i)return a=t,!1}),a},pe.map_tools.find_markers_to_remove=function(e,i){return $.map(e,function(e){if(e.type===pe.Map.marker_types.USER_LOCATION)return!0;var t=pe.map_tools.get_marker_object(i,e);return t?!1===t.map_visibility?e:JSON.stringify(e.events)!==JSON.stringify(t.events)?e:void 0:e})},pe.map_tools.find_objects_to_add=function(i,e){var a=[];return $.each(e,function(e,t){pe.map_tools.markers_contain_venue(i,t)||a.push(t)}),a},pe.map_tools.find_venue_by_name_in_array=function(e,i){var a=null;return $.each(e,function(e,t){if(t.name===i)return a=t,!1}),a},pe.map_tools.get_city_name_from_google_address_lookup_result=function(e){var a=null;return $.each(e.address_components,function(e,t){var i=!1;if($.each(t.types,function(e,t){"locality"===t&&(i=!0)}),i)return a=t.long_name,!1}),a},pe.map_tools.get_marker_object=function(e,i){var a=null;return $.each(e,function(e,t){if(i.object_id===t.id)return a=t,!1}),a},pe.map_tools.markers_contain_venue=function(e,i){var a=!1;return $.each(e,function(e,t){if(t.object_id===i.id&&JSON.stringify(t.events)===JSON.stringify(i.events))return!(a=!0)}),a},pe.map_tools.marker_icon=function(e,t){var i="http://www.partyearth.com/assets/map/";switch(e){case pe.Map.marker_types.CITY:i+="city.png";break;case pe.Map.marker_types.CURRENT_OBJECT:i+="location.png";break;case pe.Map.marker_types.EVENT:i+=t.disabled?"event_transparent.png":"event.png";break;case pe.Map.marker_types.EVENT_HIGHLIGHTED:i+="event_highlighted.png";break;case pe.Map.marker_types.HOTSPOT:i+=t.disabled?"hotspot_transparent.png":"hotspot.png";break;case pe.Map.marker_types.LANDMARK:i+="landmark.png";break;case pe.Map.marker_types.OTHER_EVENT:i+="event_small.png";break;case pe.Map.marker_types.OTHER_VENUE:i+="venue_small.png";break;case pe.Map.marker_types.RUNNERS:i+="pamplona/runners.png";break;case pe.Map.marker_types.SPECTATORS:i+="pamplona/spectators.png";break;case pe.Map.marker_types.TIME:i+="pamplona/time.png";break;case pe.Map.marker_types.USER_LOCATION:i+="location.png";break;case pe.Map.marker_types.VENUE:i+=t.disabled?"venue_transparent.png":"venue.png"}return i},pe.map_tools.numbered_marker_icon=function(e,t){return"http://cdn.partyearth.com/assets/map/pins/"+e.toLowerCase()+"/map/"+pe.map_tools.format_marker_id(String(t))+".png"},pe.map_tools.format_marker_id=function(e){return 3<e.length?"0000":"0000".substr(0,4-e.length)+e},pe.map_tools.objects_have_marker=function(e,i){var a=!1;return $.each(e,function(e,t){if(i.object_id===t.id&&JSON.stringify(i.events)===JSON.stringify(t.events))return!(a=!0)}),a},pe.map_tools.remove_marker_from_array=function(e,t){return $.map(e,function(e){return e.object_id===t.object_id?null:e})},pe.map_tools.venues_contain_venue=function(e,i){var a=!1;return $.each(e,function(e,t){if(t.id===i)return!(a=!0)}),a},pe.routes.map={search_autocomplete:"{{city_id}}/search/autocomplete.ehtml/",api_user_list:"/api/user_lists/{{id}}",api_reorder_user_list:"/api/user_lists/{{id}}/reorder",api_user_list_favorites:"/api/user_lists/{{id}}/favorites",api_favorite:"/api/favorites/{{id}}",api_favorite_vote_yes:"/api/favorites/{{id}}/vote_yes",api_favorite_vote_huh:"/api/favorites/{{id}}/vote_huh",holiday:"/{{city_id}}/holidays/{{id}}-7",holiday_comments:"/services/holidays/{{id}}/comments",holiday_reactions:"/holidays/{{id}}/reactions/all",new_holiday_reactions:"/holidays/{{id}}/reactions",holiday_calendar:"/{{city_id}}/holidays/{{id}}-7/calendar",holiday_photos:"/api/{{city_id}}/holidays/{{id}}/photos",holiday_map_venues:"/api/maps/holidays/{{slug}}/venues",holiday_map_events:"/api/maps/holidays/{{slug}}/events",venue_map_popup:"/venues/{{venue_id}}/map_popup",map_venues:"/api/cities/{{city_id}}/maps/venues",map_events:"/api/cities/{{city_id}}/maps/events",map_neighborhood_venues:"/api/maps/neighborhoods/{{neighborhood_id}}/venues",map_neighborhood_events:"/api/maps/neighborhoods/{{neighborhood_id}}/events",map_neighborhood_endpoint_venues:"/api/maps/neighborhoods/{{neighborhood_id}}/endpoints/{{endpoint_id}}/venues",map_neighborhood_endpoint_events:"/api/maps/neighborhoods/{{neighborhood_id}}/endpoints/{{endpoint_id}}/events",user_list_map_venues:"/api/maps/users/{{user_id}}/lists/{{id}}/venues",user_list_map_events:"/api/maps/users/{{user_id}}/lists/{{id}}/events",create_button_user_dashboard_event:"/users/{{user_id}}/dashboard/buttons/{{id}}",generate_button_user_dashboard_event:"/users/{{user_id}}/dashboard/buttons/{{id}}/generate",boxoffice:"/users/{{user_id}}/dashboard/{{id}}/boxoffice",boxoffice_check_ticket_number:"/users/{{user_id}}/dashboard/{{id}}/boxoffice/{{ticket_number}}/check",user_dashboard_detail:"/users/{{user_id}}/dashboard/{{id}}",user_dashboard_details:"/users/{{user_id}}/dashboard",user_list:"/users/{{user_id}}/lists/{{id}}",user_lists:"/users/{{user_id}}/lists",user_comments:"/users/{{user_id}}/comments",user_reviews:"/users/{{user_id}}/reviews",list_items:"/lists/{{id}}/list_items",list_comments:"/services/lists/{{id}}/comments",list_reactions:"/lists/{{id}}/reactions/all",new_list_reactions:"/lists/{{id}}/reactions",user_personalities:"/users/{{id}}/personalities",user:"/users/{{id}}",api_user:"/api/users/{{id}}",event:"/{{city_id}}/{{*endpoints}}/{{id}}-1",tickets:"/{{city_id}}/{{*endpoints}}/{{id}}-1/tickets",purchase_tickets:"/{{city_id}}/{{*endpoints}}/{{id}}-1/tickets/purchase",tickets_purchase_form:"/{{city_id}}/{{*endpoints}}/{{id}}-1/tickets/purchase_form",tickets_confirmation:"/{{city_id}}/{{*endpoints}}/{{id}}-1/tickets/confirmation",api_ticket_orders:"/api/ticket_orders",api_close_ticket_order:"/api/ticket_orders/{{id}}/close",api_apply_ticket_order_promo_code:"/api/ticket_orders/apply_promo",api_remove_ticket_order_promo_code:"/api/ticket_orders/remove_promo",api_ticket_orders_disable_pending:"/api/ticket_orders/disable_pending",api_ticket_orders_countdown_seconds:"/api/ticket_orders/countdown_seconds",api_ticket_order_status:"/api/ticket_orders/{{id}}/status",admin_event_ticket_types:"/admin/events/{{event_id}}/ticket_types",admin_event_ticket_promo_codes:"/admin/events/{{event_id}}/ticket_promo_codes",update_status_admin_event_ticket_promo_codes:"/admin/events/{{event_id}}/ticket_promo_codes/{{id}}/update_status",event_type_tags:"/api/tags/event_types",find_your_scene:"/services/find_your_scene.ehtml",missing_info:"/services/contact_messages/missing_info.ehtml",send_message:"/services/contact_messages/",subscription_select:"/services/subscriptions/web.ehtml",subscriptions_create:"/services/subscriptions/web",creeper_dialog:"/services/creeper.ehtml",creeper_subscribe:"/services/creeper/subscribe",creeper_close:"/services/creeper/close",character:"/pe-reviewers/{{id}}.ehtml",ask_party_earth:"/api/questions",mobile_subscribe:"/services/subscriptions/mobile",client_signup_form:"/clients/forms.ehtml"},pe.routes.build_path=function(e,t){var i=pe.routes.map[e],a=i.match(/\{\{\*(.+)\}\}/);return _.each(a,function(e){t[e]&&(t[e]=t[e].join("/"))}),i=i.replace(/\*/,""),t=t||{},pe.routes.clean_url(pe.templatize(i,t))},pe.routes.clean_url=function(e){return("/"+e).replace(/#[^$\/]+/,"").replace(/(^[^?]+)([^:])\/\//,"$1$2/").replace(/\/\//g,"/")},pe.routes.current_url_params=function(){var e=pe.routes.recognize_path(window.location.pathname);return e?e.params:{}},pe.routes.recognize_path=function(t){var i,a;t=pe.routes.clean_url(t);var e=_.find(_.keys(pe.routes.map),function(e){return i=pe.routes.map[e],(a=new RegExp(i.replace(/\//g,"\\/").replace(/\{\{[^\{\}]+\}\}/g,"(.+)"))).test(t)});if(e){for(var s=_.map(i.match(/\{\{[^\}]+\}\}/g),function(e){return e.replace(/\{|\}/g,"")}),o=t.match(a).slice(1,99),n={params:{}},r=function(e){return!_.isEmpty(e)},p=0;p<s.length;p++)"*"==s[p][0]&&(s[p]=s[p].replace(/\*/g,""),o[p]=_.select(o[p].replace(/\*/g,"").split("/"),r)),n.params[s[p]]=o[p];return n.path_info={name:e,template:i},n}return!1},pe.routes.Request=function(e,t,i){pe.routes.map[e]?(this.path=e,"object"!=typeof t&&(t={id:t}),this.params=t,this.callback=i):alert("This path is not registered in the routes map.")},pe.routes.Request.factory=function(e,t,i){return new pe.routes.Request(e,t,i)},pe.routes.Request.from_current_location=function(e,t,i){t=t||{};var a=pe.routes.current_url_params();return new pe.routes.Request(e,_.extend(a,t),i)},pe.routes.Request.prototype.ajax=function(e,t){var i="function"==typeof t?t:this.callback;$.ajax({url:this.build_path(),data:this.params,type:e,success:i})},pe.routes.Request.prototype.build_path=function(){return pe.routes.build_path(this.path,this.params)},pe.routes.Request.prototype.get=function(e){this.ajax("GET",e)},pe.routes.Request.prototype.post=function(e){this.ajax("POST",e)},pe.Map=function(e,t,i,a,s,o){pe.init_widget(this,e),o=o||{},this.map=new google.maps.Map(e[0],{zoom:a,center:new google.maps.LatLng(t,i),mapTypeId:s,minZoom:2,scrollwheel:!1,mapTypeControlOptions:{style:google.maps.MapTypeControlStyle.DROPDOWN_MENU},navigationControlOptions:{style:google.maps.NavigationControlStyle.SMALL}}),this.bounds=new google.maps.LatLngBounds,google.maps.event.addListener(this.map,"zoom_changed",this.callback(this.zoom_changed)),google.maps.event.addListener(this.map,"dragend",this.callback(this.dragend));var n=new google.maps.OverlayView;n.draw=function(){},n.setMap(this.map),this.overlay=n;var r=$(".MapTooltip");0===r.length&&(r=$('<div class="map_tooltip MapTooltip"></div>'),e.parent().append(r)),this.map_tooltip=r;var p=$(".MapPopup");0===p.length&&(p=$('<div class="map_popup MapPopup"></div>'),e.parent().append(p)),this.map_popup=p,this.markers={},this.markers.CITY=[],this.markers.CURRENT_OBJECT=[],this.markers.EVENT=[],this.markers.LANDMARK=[],this.markers.USER_LOCATION=[],this.markers.VENUE=[],this.current_venue_ids=[],this.global_zoom_level_limit=8,this.current_zoom_level=a,this.zoom_state=null,this.zoom_changed(),this.clicked_marker=null,this.default_city=o.city,this.show_tooltips=!0},pe.Map.events={CITY_CHANGED:"Map_CITY_CHANGED",CITY_MARKER_CLICKED:"Map_CITY_MARKER_CLICKED",DRAGEND:"Map_DRAGEND",MARKER_CLICKED:"Map_MARKER_CLICKED",MARKER_HOVERED:"Map_MARKER_HOVERED",MARKER_BLURRED:"Map_MARKER_BLURRED",LANDMARK_MARKER_CLICKED:"Map_LANDMARK_MARKER_CLICKED",ZOOM_LEVEL_CHANGED:"Map_ZOOM_LEVEL_CHANGED",ZOOM_STATE_CHANGED:"Map_ZOOM_STATE_CHANGED"},pe.Map.marker_types={CITY:"CITY",CURRENT_OBJECT:"CURRENT_OBJECT",EVENT:"EVENT",EVENT_HIGHLIGHTED:"EVENT_HIGHLIGHTED",HOTSPOT:"HOTSPOT",LANDMARK:"LANDMARK",OTHER_EVENT:"OTHER_EVENT",OTHER_VENUE:"OTHER_VENUE",RUNNERS:"Tip for Runners",SPECTATORS:"Tip for Spectators",TIME:"Pamplona Run Time",USER_LOCATION:"USER_LOCATION",VENUE:"VENUE"},pe.Map.zoom_states={GLOBAL:"GLOBAL",LOCAL:"LOCAL"},pe.Map.prototype.add_marker=function(e){var t=e.small_pin?500:1e3;e.ordering&&(t-=e.ordering);var i={position:new google.maps.LatLng(e.latitude,e.longitude),map:this.map,icon:e.icon,cursor:this.show_tooltips?"pointer":"https://maps.gstatic.com/mapfiles/openhand_8_8.cur",zIndex:e.zIndex||t},a=new google.maps.Marker(i);a.bubble_html=e.bubble_html,a.popup_html=e.popup_html,a.type=e.type,a.object_id=e.object_id,a.object_url=e.object_url,a.city_id=e.city_id,a.events=e.events,a.is_visible=e.is_visible,a.small_pin=e.small_pin,a.ordering=e.ordering,a.favorite_id=e.favorite_id;var s=this;return s.show_tooltips&&google.maps.event.addListener(a,"click",function(){s.marker_clicked(a),s.fire_event(pe.Map.events.MARKER_CLICKED,this)}),s.show_tooltips&&google.maps.event.addListener(a,"mouseover",function(){s.marker_hovered(a),s.fire_event(pe.Map.events.MARKER_HOVERED,this)}),google.maps.event.addListener(a,"mouseout",function(){s.marker_blurred(a),s.fire_event(pe.Map.events.MARKER_BLURRED,this)}),this.markers[e.type].push(a),a},pe.Map.prototype.centrize=function(){var e=this.map.getCenter();google.maps.event.trigger(this.map,"resize"),this.map.setCenter(e)},pe.Map.prototype.centrize_bounds=function(){var e=this.bounds.getCenter();google.maps.event.trigger(this.map,"resize"),this.map.setCenter(e)},pe.Map.prototype.centrize_to_marker=function(e){var t=e||_.sortBy(_.union(this.markers.VENUE,this.markers.EVENT),function(e){return e.ordering})[0];if(t){var i=t.position;google.maps.event.trigger(this.map,"resize"),this.map.setCenter(i)}},pe.Map.prototype.marker_coordinates_weights=function(e){return e.small_pin?{left:{x:15,y:40},right:{x:15,y:40}}:{left:{x:15,y:50},right:{x:25,y:50}}},pe.Map.prototype.marker_blurred=function(){this.map_tooltip.hide()},pe.Map.prototype.marker_hovered=function(e){this.clicked_marker!=e&&(this.map_tooltip.html(e.bubble_html),this.map_tooltip.show(),this.set_popup_tooltip_div_position(this.map_tooltip,e))},pe.Map.prototype.marker_clicked=function(e){switch((this.clicked_marker=e).type){case pe.Map.marker_types.VENUE:e.is_visible&&this.show_popup(e);break;case pe.Map.marker_types.EVENT:this.show_popup(e)}},pe.Map.prototype.set_popup_tooltip_div_position=function(e,t){var i=this.marker_position_on_map(t),a=this.container.width(),s=this.marker_coordinates_weights(t);i.x>a/2?(e.css("right",a-i.x+s.right.x),e.css("left",""),e.css("top",i.y-s.right.y),e.removeClass("map_popup_right")):(e.css("right",""),e.css("left",i.x+s.left.x),e.css("top",i.y-s.left.y),e.addClass("map_popup_right"))},pe.Map.prototype.marker_position_on_map=function(e){var t=this.overlay.getProjection(),i=e.getPosition();return t.fromLatLngToContainerPixel(i)},pe.Map.prototype.marker_position_on_page=function(e){var t=this.marker_position_on_map(e);return{x:this.container.offset().left+t.x,y:this.container.offset().top+t.y}},pe.Map.prototype.bubble_template_city=function(e){return pe.templatize('<div class="bubble_text"><span class="bubble_headline">{{name}}</span></div>',e)},pe.Map.prototype.bubble_template_event=function(e){if(e.events){var t=e.events[0],i=t.start_date||t.date;t.formatted_date=i?$.datepicker.formatDate("M d",new Date(i)):"",e.events_text=pe.templatize('<li><span class="event_date">{{formatted_date}}</span><a href="{{url}}" class="blue_text">{{name}}</a></li>',t)}return pe.templatize('<div class="map_tooltip_content"><div class="map_popup_tip"><div class="map_popup_tip_inner"></div></div><span class="title">{{name}}</span><ul class="event_list">{{events_text}}</ul></div>',e)},pe.Map.prototype.bubble_template_landmark=function(e){return pe.templatize('<div class="map_tooltip_content"><div class="map_popup_tip"><div class="map_popup_tip_inner"></div></div><span class="title">{{name}}</span></div>',e)},pe.Map.prototype.bubble_template_venue=function(e){return e.venue_types_text=e.venue_types.join(" / "),pe.templatize('<div class="map_tooltip_content"><div class="map_popup_tip"><div class="map_popup_tip_inner"></div></div><span class="title">{{name}}</span><span class="venue_type">{{venue_types_text}}</span></div>',e)},pe.Map.prototype.city_marker_clicked=function(e){this.fire_event(pe.Map.events.CITY_MARKER_CLICKED,e)},pe.Map.prototype.landmark_marker_clicked=function(e){this.fire_event(pe.Map.events.LANDMARK_MARKER_CLICKED,e)},pe.Map.prototype.popup_template_landmark=function(e){return e.image="",e.thumbnail&&(e.image=pe.templatize('<div class="map_venue_img float_left ConvertToRoundedCorners"><img src="'+pe.https(pe.assign_photo_size(e.thumbnail,"100","100x100"))+'" /></div>',e)),pe.templatize('<div class="map_popup_content"><div class="map_popup_close CloseButton"></div><div class="map_popup_tip"><div class="map_popup_tip_inner"></div></div><div class="header">{{name}}</div><div class="main clearfix">{{image}}<div class="details">{{description}}</div></div></div>',e)},pe.Map.prototype.popup_template_user_location=function(e){return pe.templatize('<div class="user_location_popup" style="width:200px !important; height:80px !important;">{{user_location}}</div>',{user_location:e})},pe.Map.prototype.remove_marker=function(e){e.setMap(null),this.markers[e.type]=pe.map_tools.remove_marker_from_array(this.markers[e.type],e)},pe.Map.prototype.set_cities=function(e){$.each(this.markers.CITY,this.callback(function(e,t){this.remove_marker(t)})),$.each(e,this.callback(function(e,t){var i=this.bubble_template_city(t);this.add_marker({type:pe.Map.marker_types.CITY,icon:pe.map_tools.marker_icon(pe.Map.marker_types.CITY,t),object_id:t.id,object_url:t.url,latitude:t.latitude,longitude:t.longitude,bubble_html:i,marker_clicked:this.callback(this.city_marker_clicked)})}))},pe.Map.prototype.set_current_event=function(e){var t=pe.map_tools.event_map_data([e]),i=pe.map_tools.find_objects_to_add(this.markers.EVENT,t);$.each(i,this.callback(function(e,t){this.add_marker({type:pe.Map.marker_types.CURRENT_OBJECT,icon:pe.map_tools.marker_icon(pe.Map.marker_types.CURRENT_OBJECT,t),zIndex:1500,object_id:t.id,object_url:t.url,latitude:t.latitude,longitude:t.longitude,bubble_html:this.bubble_template_event(t),city_id:t.city_id,events:t.events}),this.current_venue_ids.push(t.id)}))},pe.Map.prototype.set_current_venue=function(e){this.add_marker({type:pe.Map.marker_types.CURRENT_OBJECT,icon:pe.map_tools.marker_icon(pe.Map.marker_types.CURRENT_OBJECT,e),zIndex:2e3,object_id:e.id,object_url:e.url,latitude:e.latitude,longitude:e.longitude,bubble_html:this.bubble_template_venue(e),city_id:e.city_id}),this.current_venue_ids.push(e.id)},pe.Map.prototype.set_events=function(e,o){var t=pe.map_tools.event_map_data(e),i=pe.map_tools.find_markers_to_remove(this.markers.EVENT,t);$.each(i,this.callback(function(e,t){-1<this.current_venue_ids.indexOf(t.object_id)||this.remove_marker(t)}));var a=pe.map_tools.find_objects_to_add(this.markers.EVENT,t);$.each(a,this.callback(function(e,t){var i=t.small_pin?pe.Map.marker_types.OTHER_EVENT:pe.Map.marker_types.EVENT,a=o?pe.map_tools.numbered_marker_icon("event",t.ordering):pe.map_tools.marker_icon(i,t);if(!(-1<this.current_venue_ids.indexOf(t.id))){var s=this.add_marker({small_pin:t.small_pin,type:pe.Map.marker_types.EVENT,icon:a,object_id:t.id,object_url:t.url,latitude:t.latitude,longitude:t.longitude,bubble_html:this.bubble_template_event(t),city_id:t.city_id,events:t.events,favorite_id:t.favorite_id,ordering:t.ordering});this.bounds.extend(s.position)}}))},pe.Map.prototype.set_landmarks=function(e){$.each(this.markers.LANDMARK,this.callback(function(e,t){this.remove_marker(t)})),$.each(e,this.callback(function(e,t){0===t.type&&t.map_visibility&&this.add_marker({type:pe.Map.marker_types.LANDMARK,icon:pe.map_tools.marker_icon(pe.Map.marker_types.LANDMARK,t),object_id:t.id,object_url:t.url,latitude:t.latitude,longitude:t.longitude,bubble_html:this.bubble_template_landmark(t),popup_html:this.popup_template_landmark(t),marker_clicked:this.callback(this.landmark_marker_clicked)})}))},pe.Map.prototype.set_venues=function(e,n){var t=pe.map_tools.find_markers_to_remove(this.markers.VENUE,e);$.each(t,this.callback(function(e,t){-1<this.current_venue_ids.indexOf(t.object_id)||this.remove_marker(t)}));var i=pe.map_tools.find_objects_to_add(this.markers.VENUE,e);$.each(i,this.callback(function(e,t){if(!(-1<this.current_venue_ids.indexOf(t.id))){var i=this.bubble_template_venue(t),a=t.small_pin?pe.Map.marker_types.OTHER_VENUE:pe.Map.marker_types.VENUE,s=n?pe.map_tools.numbered_marker_icon("venue",t.ordering):pe.map_tools.marker_icon(a,t),o=this.add_marker({small_pin:t.small_pin,type:pe.Map.marker_types.VENUE,icon:s,object_id:t.id,object_url:t.url,latitude:t.latitude,longitude:t.longitude,is_visible:t.is_visible,bubble_html:i,city_id:t.city_id,favorite_id:t.favorite_id,ordering:t.ordering});this.bounds.extend(o.position)}}))},pe.Map.prototype.set_view=function(e,t,i){this.map.setCenter(new google.maps.LatLng(e,t));var a=parseInt(i,10);isNaN(a)||(this.map.setZoom(a),this.zoom_changed())},pe.Map.prototype.show_popup=function(t){this.map_tooltip.hide(),this.map_popup.hide(),(this.default_city===t.city_id?this.load_venue_popup:this.load_default_venue_popup)(t,this.callback(function(e){this.map_popup.html(e),new pe.CloseButton(this.map_popup,pe.CloseButton.close_methods.HIDE).bind_event(pe.CloseButton.events.CLOSED,this.callback(function(){this.clicked_marker=null})),this.set_popup_tooltip_div_position(this.map_popup,t),this.map_popup.show()}))},pe.Map.prototype.switch_to_global_view=function(){this.zoom_state=pe.Map.zoom_states.GLOBAL,this.map.setMapTypeId(google.maps.MapTypeId.TERRAIN),pe.ajax_loader.cities.load(this.callback(function(e){this.set_cities(e),this.set_venues([]),this.set_events([])})),this.fire_event(pe.Map.events.ZOOM_STATE_CHANGED,this.zoom_state)},pe.Map.prototype.switch_to_local_view=function(t){this.zoom_state=pe.Map.zoom_states.LOCAL,this.map.setMapTypeId(google.maps.MapTypeId.ROADMAP),setTimeout(this.callback(function(){var e=this.map.getBounds();t===this.global_zoom_level_limit&&pe.ajax_loader.locate_city.load({north:e.getNorthEast().lat(),south:e.getSouthWest().lat(),east:e.getNorthEast().lng(),west:e.getSouthWest().lng()},this.callback(function(e){1===e.length&&this.load_default_map_objects(e[0].id),this.fire_event(pe.Map.events.ZOOM_STATE_CHANGED,this.zoom_state)}))}),0)},pe.Map.prototype.load_default_map_objects=function(t){var e=this.default_city===t?this.load_venues:this.load_default_venues,i=this.default_city===t?this.load_events:this.load_default_events;e(t,this.callback(function(e){this.set_venues(e),this.fire_event(pe.Map.events.CITY_CHANGED,t),this.set_cities([])})),i(t,this.callback(function(e){this.set_events(e)}))},pe.Map.prototype.load_default_venues=function(e,t){pe.routes.Request.factory("map_venues",{city_id:e}).get(function(e){t(pe.json_expander.expand_venues(e))})},pe.Map.prototype.load_default_events=function(e,t){pe.routes.Request.factory("map_events",{city_id:e}).get(function(e){t(pe.json_expander.expand_events(e))})},pe.Map.prototype.load_default_venue_popup=function(e,t){pe.routes.Request.factory("venue_map_popup",{venue_id:e.object_id}).get(t)},pe.Map.prototype.load_venues=function(e,t){pe.routes.Request.factory("map_venues",{city_id:e}).get(function(e){t(pe.json_expander.expand_venues(e))})},pe.Map.prototype.load_events=function(e,t){pe.routes.Request.factory("map_events",{city_id:e}).get(function(e){t(pe.json_expander.expand_events(e))})},pe.Map.prototype.load_venue_popup=function(e,t){pe.routes.Request.factory("venue_map_popup",{venue_id:e.object_id}).get(t)},pe.Map.prototype.dragend=function(){this.clicked_marker&&(this.map.getBounds().contains(this.clicked_marker.getPosition())?this.set_popup_tooltip_div_position(this.map_popup,this.clicked_marker):(this.map_popup.hide(),this.clicked_marker=null))},pe.Map.prototype.zoom_changed=function(){this.map_popup.hide();var e=this.map.getZoom();e<this.global_zoom_level_limit&&this.zoom_state!==pe.Map.zoom_states.GLOBAL&&this.switch_to_global_view(),e>=this.global_zoom_level_limit&&this.zoom_state!==pe.Map.zoom_states.LOCAL&&this.switch_to_local_view(e),this.fire_event(pe.Map.events.ZOOM_LEVEL_CHANGED,e)},pe.CustomVideoPlayer=function(e,t,i,a,s,o){pe.init_widget(this,e),this.event_lock_duration=300,this.slider_area_padding_offset=46,this.slider_area_padding_offset_ie8_fullscreen=46;var n=e.width();pe.browser_is_ie8()&&o&&(n-=17);var r={wmode:"transparent",controls:0,start:s||0};a&&(r.autoplay=1),this.player=new YT.Player(t,{width:n,height:e.height()-(o?42:150),videoId:i,playerVars:r,events:{onStateChange:this.callback(this.player_state_changed),onError:this.callback(this.on_error)}}),this.player_div_id=t,this.current_youtube_id=i,this.play_button=e.find(".PlayButton"),this.play_button.unbind("click"),this.play_button.click(this.callback(this.play_button_clicked)),this.play_button.mousedown(this.callback(this.play_button_mouse_down)),this.play_button.mouseup(this.callback(this.play_button_mouse_up)),this.play_button.mouseleave(this.callback(this.play_button_mouse_leave)),this.elapsed_time_display=e.find(".ElapsedTime"),this.total_time_div=e.find(".TotalTime"),this.progress_bar_div=e.find(".ProgressBar"),this.progress_bar_div.unbind("mousemove"),this.progress_bar_div.mousemove(this.callback(this.progress_bar_mouse_move)),this.progress_bar_div.unbind("mouseenter"),this.progress_bar_div.mouseenter(this.callback(this.progress_bar_mouse_enter)),this.progress_bar_div.unbind("mouseleave"),this.progress_bar_div.mouseleave(this.callback(this.progress_bar_mouse_leave)),this.buffered_bar=e.find(".BufferedBar"),this.buffered_bar.width(0),this.played_bar=e.find(".PlayedBar"),this.played_bar.width(0),this.mute_button=e.find(".Mute"),this.mute_button.unbind("click"),this.mute_button.click(this.callback(this.mute_button_clicked)),this.volume_lights={};var p=this.callback(this.volume_light_clicked),_=this.callback(this.volume_light_mouse_entered);e.find(".Volume .Display .Light").each(this.callback(function(e,t){var i=$(t);i.unbind("click"),i.click(p),i.unbind("mouseenter"),i.mouseenter(_);var a=parseInt(i.attr("data-volume"),10);this.volume_lights[a]=i})),this.volume_div=e.find(".Controls .Volume"),this.volume_div.unbind("mousedown"),this.volume_div.mousedown(this.callback(this.on_mouse_down)),this.volume_div.unbind("mouseup"),this.volume_div.mouseup(this.callback(this.on_mouse_up)),this.mouse_is_pressed=!1,this.fullscreen_button=e.find(".Fullscreen"),this.fullscreen_button.unbind("click"),this.fullscreen_button.click(this.callback(this.fullscreen_button_clicked)),this.fullscreen_button.mousedown(this.callback(this.fullscreen_button_mousedown)),this.fullscreen_button.mouseup(this.callback(this.fullscreen_button_mouseup)),this.fullscreen_button.mouseleave(this.callback(this.fullscreen_button_mouseleave)),this.is_playing=!1,this.timer_id=null,this.total_seconds=0,this.total_bytes=0,this.update_frequency=500,this.slider=e.find(".ProgressBar .Slider").slider({slide:this.callback(this.on_sliding),start:this.callback(this.on_sliding_start),stop:this.callback(this.on_sliding_stop)}),this.progress_sliding=!1,this.progressbar_popup_offset_x=-18,this.progressbar_popup_offset_y=-20,$(".ProgressBarPopup").remove(),this.progressbar_hover_div=$('<div class="ProgressBarPopup"></div>'),this.progressbar_hover_div.appendTo("body"),this.progressbar_hover_div.hide(),this.offset=pe.browser_is_ie8()&&o?this.slider_area_padding_offset_ie8_fullscreen:this.slider_area_padding_offset,this.total_bar_width=n-this.play_button.width()-$(".TimeDisplay").width()-this.volume_div.width()-this.fullscreen_button.width()-this.offset,this.progress_bar_div.width(this.total_bar_width);var l=this.progress_bar_div.offset().left;this.total_bar_offset_x="number"==typeof l?l:0,this.player_volume=100},pe.CustomVideoPlayer.events={ENDED:"CustomVideoPlayer_ENDED",FULLSCREEN:"CustomVideoPlayer_FULLSCREEN"},pe.CustomVideoPlayer.prototype.current_video_id=function(){return this.current_youtube_id},pe.CustomVideoPlayer.prototype.current_video_playtime=function(){return this.player.getCurrentTime()},pe.CustomVideoPlayer.prototype.destroy=function(){clearInterval(this.timer_id),this.container.find("#"+this.player_div_id).empty(),this.container.unbind()},pe.CustomVideoPlayer.prototype.fullscreen_button_clicked=function(){this.fire_event(pe.CustomVideoPlayer.events.FULLSCREEN)},pe.CustomVideoPlayer.prototype.fullscreen_button_mousedown=function(){this.fullscreen_button.addClass("pressed")},pe.CustomVideoPlayer.prototype.fullscreen_button_mouseleave=function(){this.fullscreen_button.removeClass("pressed")},pe.CustomVideoPlayer.prototype.fullscreen_button_mouseup=function(){this.fullscreen_button.removeClass("pressed")},pe.CustomVideoPlayer.prototype.load_and_play_video=function(e){this.player.loadVideoById(e),this.play_button.addClass("playing").removeClass("paused"),this.current_youtube_id=e},pe.CustomVideoPlayer.prototype.mute_button_clicked=function(){if(this.player)if(this.player.isMuted()){this.player.unMute(),this.mute_button.removeClass("on").addClass("off");this.player.getVolume();this.set_volume(this.player_volume)}else this.player.mute(),this.mute_button.removeClass("off").addClass("on"),$.each(this.volume_lights,function(e,t){$(t).removeClass("on").addClass("off")})},pe.CustomVideoPlayer.prototype.on_error=function(){alert("Youtube error, please try again later.")},pe.CustomVideoPlayer.prototype.on_mouse_down=function(){this.mouse_is_pressed=!0},pe.CustomVideoPlayer.prototype.on_mouse_up=function(){this.mouse_is_pressed=!1},pe.CustomVideoPlayer.prototype.play_button_mouse_leave=function(){this.play_button.removeClass("pressed")},pe.CustomVideoPlayer.prototype.play_button_mouse_down=function(){this.play_button.addClass("pressed")},pe.CustomVideoPlayer.prototype.play_button_mouse_up=function(){this.play_button.removeClass("pressed")},pe.CustomVideoPlayer.prototype.on_sliding=function(e,t){this.player.seekTo(t.value,!1)},pe.CustomVideoPlayer.prototype.on_sliding_start=function(){this.progress_sliding=!0},pe.CustomVideoPlayer.prototype.on_sliding_stop=function(e,t){this.player.seekTo(t.value,!0),this.progress_sliding=!1},pe.CustomVideoPlayer.prototype.play_button_clicked=function(){this.is_playing?this.player.pauseVideo():this.player.playVideo()},pe.CustomVideoPlayer.prototype.player_state_changed=function(e){switch(e.data){case YT.PlayerState.ENDED:if(this.ended_event_lock)return;this.ended_event_lock=1,
setTimeout(this.callback(function(){this.ended_event_lock=0}),this.event_lock_duration),this.fire_event(pe.CustomVideoPlayer.events.ENDED);break;case YT.PlayerState.PLAYING:this.is_playing=!0,this.play_button.removeClass("paused"),this.play_button.addClass("playing"),this.total_seconds=0,this.video_bytes_total=0,this.timer_id||(this.timer_id=setInterval(this.callback(this.update_player_ui),this.update_frequency));break;case YT.PlayerState.PAUSED:this.play_button.removeClass("playing"),this.play_button.addClass("paused"),this.is_playing=!1}},pe.CustomVideoPlayer.prototype.progress_bar_mouse_leave=function(){this.progressbar_hover_div.hide()},pe.CustomVideoPlayer.prototype.progress_bar_mouse_enter=function(){this.progressbar_hover_div.css("top",this.progress_bar_div.offset().top+this.progressbar_popup_offset_y),this.progressbar_hover_div.show()},pe.CustomVideoPlayer.prototype.progress_bar_mouse_move=function(e){var t=(e.pageX-this.total_bar_offset_x)/this.total_bar_width*this.total_seconds;this.progressbar_hover_div.html(pe.format_duration(t)),this.progressbar_hover_div.css("left",e.pageX+this.progressbar_popup_offset_x)},pe.CustomVideoPlayer.prototype.set_volume=function(a){this.mute_button.removeClass("on").addClass("off"),this.player.setVolume(a),this.player_volume=a,$.each(this.volume_lights,function(e,t){var i=$(t);a<e?i.addClass("off").removeClass("on"):i.addClass("on").removeClass("off")})},pe.CustomVideoPlayer.prototype.update_player_ui=function(){if(this.timer_id){this.total_seconds||(this.total_seconds=this.player.getDuration(),this.total_seconds&&(this.total_time_div.html(pe.format_duration(this.total_seconds)),this.slider.slider("option","max",this.total_seconds)));var e=this.player.getCurrentTime();if(this.elapsed_time_display.html(pe.format_duration(e,600<this.total_seconds?2:1)),this.total_bar_width=this.container.width()-this.play_button.width()-$(".TimeDisplay").width()-this.volume_div.width()-this.fullscreen_button.width()-this.offset,this.progress_bar_div.width(this.total_bar_width),this.total_bytes||(this.total_bytes=this.player.getVideoBytesTotal()),this.total_bytes){var t=(this.player.getVideoBytesLoaded()+this.player.getVideoStartBytes())/this.total_bytes;this.buffered_bar.width(t*this.total_bar_width)}if(this.total_seconds){var i=this.player.getCurrentTime(),a=i/this.total_seconds;this.played_bar.width(a*this.total_bar_width),this.progress_sliding||this.slider.slider("value",i)}}},pe.CustomVideoPlayer.prototype.volume_light_clicked=function(e){var t=$(e.target).closest(".Light");this.set_volume(parseInt(t.attr("data-volume"),10))},pe.CustomVideoPlayer.prototype.volume_light_mouse_entered=function(e){if(this.mouse_is_pressed){var t=$(e.target).closest(".Light");this.set_volume(parseInt(t.attr("data-volume"),10))}},pe.Scroller=function(e,t,i,a,s,o,n,r){pe.init_widget(this,e),this.scroller_container=this.container.find(".ScreensContainer"),this.current_item=0,this.scroll_duration=t,this.inactive_button_class=i,this.visible_items_count=a||1,this.scroll_by=s||1,this.single_item_width=o,this.individual_items=this.scroller_container.find(".IndividualItem"),this.items_count=this.individual_items.length,this.next_button=this.container.find(".NextButton"),this.next_button.click(this.callback(this.next_button_clicked)),this.previous_button=this.container.find(".PreviousButton"),this.previous_button.click(this.callback(this.previous_button_clicked)),this.page_display_container=this.container.find(".PageDisplay"),this.page_display_format=n||"",this.loop_scrolling=r||!1,this.update_display()},pe.Scroller.prototype.animate_scrolling=function(e){if(e!=this.current_item){this.current_item=e;var t=this.current_item*(this.single_item_width||this.individual_items.width());this.scroller_container.animate({left:"-"+t+"px"},this.scroll_duration,"cubicEaseInOut"),this.update_display()}},pe.Scroller.prototype.update_display=function(){this.current_item<=0?this.previous_button.addClass(this.inactive_button_class):this.previous_button.removeClass(this.inactive_button_class),this.current_item>=this.items_count-this.visible_items_count?this.next_button.addClass(this.inactive_button_class):this.next_button.removeClass(this.inactive_button_class),this.page_display_container.html(pe.templatize(this.page_display_format,{current_item_number:this.current_item+1,items_count:this.items_count}))},pe.Scroller.prototype.next_button_clicked=function(){var e=this.current_item+this.scroll_by;e>this.items_count-this.visible_items_count&&(e=this.loop_scrolling?0:this.items_count-this.visible_items_count),this.animate_scrolling(e)},pe.Scroller.prototype.previous_button_clicked=function(){var e=this.current_item-this.scroll_by;e<0&&(e=this.loop_scrolling?this.items_count-this.visible_items_count:0),this.animate_scrolling(e)},pe.YoutubePlayer=function(e,t){pe.init_widget(this,e),this.player=new YT.Player("youtube_player",{width:"333",height:"250",videoId:t,playerVars:{wmode:"transparent"},events:{onStateChange:this.callback(this.on_player_state_changed),onError:this.callback(this.on_error)}}),this.ended_event_lock=0,this.event_lock_duration=300},pe.YoutubePlayer.events={ENDED:"YoutubePlayer_ENDED"},pe.YoutubePlayer.prototype.on_player_state_changed=function(e){if(e.data===YT.PlayerState.ENDED){if(this.ended_event_lock)return;this.ended_event_lock=1,setTimeout(this.callback(function(){this.ended_event_lock=0}),this.event_lock_duration),this.fire_event(pe.YoutubePlayer.events.ENDED)}},pe.YoutubePlayer.prototype.on_error=function(){alert("Youtube error, please try again later.")},pe.YoutubePlayer.prototype.load_and_play_video=function(e){this.player.loadVideoById(e)},pe.VideoSection=function(e,t){pe.init_widget(this,e),this.video_player_div=e.find(".VideoPlayer"),this.video_title_div=e.find(".VideoTitle"),$(".Video .PlayButton").click(this.callback(this.video_thumbnail_clicked)),this.scroller=new pe.Scroller(this.container.find(".MoreVideos"),1100,"hidden",1,1,t),this.embedded_player=null},pe.VideoSection.prototype.create_player=function(e,t,i,a){var s=this.container.find(".VideoPlayer");this.embedded_player=new pe.CustomVideoPlayer(s,"youtube_embedded_player",t,i,a,!1),this.embedded_player.bind_event(pe.CustomVideoPlayer.events.ENDED,this.callback(this.video_ended)),this.embedded_player.bind_event(pe.CustomVideoPlayer.events.FULLSCREEN,this.callback(this.embedded_player_fullscreen_clicked))},pe.VideoSection.prototype.embedded_player_fullscreen_clicked=function(){var e=this.embedded_player.current_video_id(),t=this.embedded_player.current_video_playtime(),i=$("#site_container").addClass("hidden");if(this.embedded_player.player.pauseVideo(),this.fullscreen_player)this.fullscreen_player.container.show(),this.fullscreen_player.player.seekTo(t),this.fullscreen_player.player.playVideo(),this.fullscreen_player.update_player_ui();else{var a='<div class="CustomFullscreenPlayer VideoPlayer full_screen_player"><div id="youtube_fullscreen_player"></div>';a+='<div class="watermark"></div>',a+='<div class="Controls controls"></div></div>';var s=$(a);s.find(".Controls").html(this.embedded_player.container.find(".Controls").html()),i.after(s),this.fullscreen_player=new pe.CustomVideoPlayer(s,"youtube_fullscreen_player",e,!0,t,!0),this.fullscreen_player.bind_event(pe.CustomVideoPlayer.events.FULLSCREEN,this.callback(this.fullscreen_player_fullscreen_button_clicked)),this.fullscreen_player.bind_event(pe.CustomVideoPlayer.events.ENDED,this.callback(this.fullscreen_video_ended))}},pe.VideoSection.prototype.fullscreen_player_fullscreen_button_clicked=function(){this.fullscreen_player.current_video_id();var e=this.fullscreen_player.current_video_playtime();this.fullscreen_player.player.pauseVideo(),this.fullscreen_player.container.hide(),$("#site_container").removeClass("hidden"),this.embedded_player.player.seekTo(e),this.embedded_player.player.playVideo(),pe.animated_scrolling($(".VideoSectionLinkTarget"),null)},pe.VideoSection.prototype.fullscreen_video_ended=function(){var e=this.container.find(".Video.playing"),t=e.next(".Video");if(t.length<1){var i=parseInt(e.attr("data_number"),10)+1;t=this.container.find(".Video[data_number="+i+"]"),this.scroller.next_button_clicked()}t.length<1&&(t=this.container.find(".Video:first"),this.scroller.animate_scrolling(0));var a=t.attr("data_youtube_id");if("string"==typeof a){this.container.find(".playing").removeClass("playing"),t.addClass("playing"),this.fullscreen_player.load_and_play_video(a),this.embedded_player.player.loadVideoById(a);var s=t.find(".Title").html();this.video_title_div.html(s)}},pe.VideoSection.prototype.play_next_video=function(){var e=this.container.find(".playing"),t=e.next(".Video");if(t.length<1){var i=parseInt(e.attr("data_number"),10)+1;t=this.container.find(".Video[data_number="+i+"]"),this.scroller.next_button_clicked()}t.length<1&&(t=this.container.find(".Video:first"),this.scroller.animate_scrolling(0));var a=new jQuery.Event;a.target=t,this.video_thumbnail_clicked(a)},pe.VideoSection.prototype.video_ended=function(){this.play_next_video()},pe.VideoSection.prototype.video_thumbnail_clicked=function(e){var t=$(e.target).closest(".Video"),i=t.attr("data_youtube_id");if("string"==typeof i){this.container.find(".playing").removeClass("playing"),t.addClass("playing"),this.embedded_player.load_and_play_video(i),this.fullscreen_player&&this.fullscreen_player.player.loadVideoById(i);var a=t.find(".Title").html();this.video_title_div.html(a)}},pe.init_calendar_buttons=function(){new pe.AddToCalendarButton},pe.AddToCalendarButton=function(){pe.init_widget(this,null),$(".AddToCalendarButton").live("click",this.callback(this.show_dialog))},pe.AddToCalendarButton.prototype.close_dialog=function(){},pe.AddToCalendarButton.prototype.show_dialog=function(e){var t=$('<div title="Add to your calendar">'),i=function(){t.empty(),t.dialog("destroy")};t.dialog({modal:!0,show:!1,close:i}),t.html('<div style="margin:0 auto; width: 80px;"><img src="/assets/content_bg/spinner.gif"/></div>');var a=$(e.currentTarget);if(params={event_id:a.data("event_id")},date=a.data("date"),params.date=date||null,_.isEmpty(a.data("event_id"))){var s=a.data("source_path");if(_.isEmpty(s))alert("NOR event_id, source_path is set for calendar button");else{var o=pe.routes.recognize_path(s);o?pe.routes.Request.factory(o.path_info.name+"_calendar",o.params,function(e){t.html(e),t.find("a").click(i)}).get():alert("Calendar route is not recognized")}}else pe.ajax_loader.add_to_calendar_dialog.load(params,function(e){t.html(e),t.find("a").click(i)});return!1},pe.mouse_position={},pe.mouse_position.x=0,pe.mouse_position.y=0,pe.mouse_position.on_mouse_move=function(e){pe.mouse_position.x=e.pageX,pe.mouse_position.y=e.pageY},pe.mouse_position.track=function(){$("body").mousemove(pe.mouse_position.on_mouse_move)},pe.RatingsModule=function(e,t,i,a){pe.init_widget(this,e),this.container.html(this.html(t,a)),this.container.addClass(a?"with_image":"no_image"),this.rating_div=this.container.find(".StarRating"),this.rating_div.html(this.render_rating(t,i))},pe.RatingsModule.prototype.html=function(e,t){var i=e.toLowerCase();return t?'<a target="_blank" title="'+pe.link_title_for_reviewer(e)+'" href="/pe-reviewers/'+i+'">  <div class="figure '+i+' ratings_sprite"></div></a><div class="StarRating big_stars"></div><h3 class="name '+i+' tab_text">  <strong>'+e+"</strong></h3>":'<div class="StarRating Stars small_stars ratings_sprite" title="'+pe.link_title_for_reviewer(e)+'"></div>'},pe.RatingsModule.prototype.render_rating=function(e,t){for(var i=[],a=e.toLowerCase(),s=1;s<=4;s++){var o=s<=t?a:"disabled";i[s]='<div class="star '+o+'"></div>'}return i.join("\n")},pe.SearchResultCharacterRatingModule=function(e,t){pe.init_widget(this,e),this.container.html(this.html());var i=this.container.find(".LucasRating"),a=t.rating_lucas,s=this.container.find(".AdrianaRating"),o=t.rating_adriana,n=this.container.find(".JonahRating"),r=t.rating_jonah,p=this.container.find(".EmmaRating"),_=t.rating_emma;a!==undefined&&new pe.RatingsModule(i,"Lucas",a,!1),o!==undefined&&new pe.RatingsModule(s,"Adriana",o,!1),r!==undefined&&new pe.RatingsModule(n,"Jonah",r,!1),_!==undefined&&new pe.RatingsModule(p,"Emma",_,!1)},pe.SearchResultCharacterRatingModule.prototype.html=function(){return'<a href="/pe-reviewers/lucas" target="_blank" title="'+pe.link_title_for_reviewer("Lucas")+'">  <div class="char_rating_small LucasRating"></div></a><a href="/pe-reviewers/adriana" target="_blank" title="'+pe.link_title_for_reviewer("Adriana")+'">  <div class="char_rating_small AdrianaRating"></div></a><a href="/pe-reviewers/jonah" target="_blank" title="'+pe.link_title_for_reviewer("Jonah")+'">  <div class="char_rating_small JonahRating"></div></a><a href="/pe-reviewers/emma" target="_blank" title="'+pe.link_title_for_reviewer("Emma")+'">  <div class="char_rating_small EmmaRating"></div></a>'},pe.VenueSearcher=function(){pe.init_widget(this,null)},pe.VenueSearcher.prototype.get_matching_venues=function(t,i){t.has_filters("city")&&"all"!==t.get_filter("city")?pe.ajax_loader.city_venues.load({city_id:t.get_filter("city")},function(e){$.each(e,function(e,t){t.disabled=null}),e=pe.VenueSearcher.filter_by_result_types(e,t),e=pe.VenueSearcher.filter_by_neighborhood(e,t),e=pe.VenueSearcher.filter_by_character(e,t),e=pe.VenueSearcher.filter_by_venue_types(e,t),e=pe.VenueSearcher.filter_by_tags(e,t),e=pe.VenueSearcher.filter_by_venue_name(e,t),e=pe.VenueSearcher.filter_by_fulltext(e,t),e=pe.VenueSearcher.filter_by_performer_name(e,t),i(e)}):i([])},pe.VenueSearcher.filter_by_city=function(e,t){var i=t.get_filter("city");return i?$.map(e,function(e){if(e.city===i)return e}):e},pe.VenueSearcher.filter_by_character=function(e,t){var i=t.get_filter("characters");if(!i||4===i.length)return e;if(0===i.length)return[];var a=[];return-1<i.indexOf("adriana")&&$.each(e,function(e,t){3<=t.rating_adriana&&!pe.map_tools.venues_contain_venue(a,t.id)&&a.push(t)}),-1<i.indexOf("lucas")&&$.each(e,function(e,t){3<=t.rating_lucas&&!pe.map_tools.venues_contain_venue(a,t.id)&&a.push(t)}),-1<i.indexOf("jonah")&&$.each(e,function(e,t){3<=t.rating_jonah&&!pe.map_tools.venues_contain_venue(a,t.id)&&a.push(t)}),-1<i.indexOf("emma")&&$.each(e,function(e,t){3<=t.rating_emma&&!pe.map_tools.venues_contain_venue(a,t.id)&&a.push(t)}),a},pe.VenueSearcher.filter_by_fulltext=function(e,t){var i=t.get_filter("fulltext");return i?$.map(e,function(e){if(pe.text_contains_query(pe.venue_search_text(e),i))return e}):e},pe.VenueSearcher.filter_by_neighborhood=function(e,t){var i=t.get_filter("neighborhood");return i&&"all"!==i&&$.each(e,function(e,t){t.neighborhood_id!==i&&(t.disabled=!0)}),e},pe.VenueSearcher.filter_by_performer_name=function(e,t){return t.get_filter("performer_name")&&$.each(e,function(e,t){t.disabled=!0}),e},pe.VenueSearcher.filter_by_result_types=function(e,t){var i=t.get_filter("result_types");if(!i||-1<i.indexOf("venues"))return e;if(-1<i.indexOf("hotspots")){var a=new Date(t.get_filter("start_date_or_default")),s=t.get_filter("end_date"),o=s?new Date(s):a;return $.map(e,function(e){if(pe.VenueSearcher.venue_is_hotspot_in_date_range(e,a,o))return e})}return[]},pe.VenueSearcher.filter_by_tags=function(e,t){var i=t.get_filter("tags");if(!i)return e;i=pe.VenueSearcher.remove_event_tags(i);var a=pe.structured_tags_as_flat_array(i);return $.map(e,function(e){if(pe.array_contains(e.tags,a))return e})},pe.VenueSearcher.filter_by_venue_name=function(e,t){var i=t.get_filter("venue_name");return i?$.map(e,function(e){if(-1<i.indexOf(e.name))return e}):e},pe.VenueSearcher.filter_by_venue_types=function(e,t){var i=t.get_filter("Venue Type");return i&&"all"!==i?$.grep(e,function(e){return pe.array_match(i,e.all_venue_types)}):e},pe.VenueSearcher.find_used_tags=function(e,i){var o={};return $.each(e,function(s,t){$.each(i,function(e,a){$.each(t,function(i,e){-1<a.tags.indexOf(i)&&(o[s]||(o[s]={}),o[s][i]||(o[s][i]=[])),$.each(e,function(e,t){-1<a.tags.indexOf(t)&&(o[s]||(o[s]={}),o[s][i]||(o[s][i]=[]),o[s][i].push(t))})})})}),o},pe.VenueSearcher.mark_venue_map_visibility=function(e,t){var i=t.get_filter("result_types"),a=!i||-1<i.indexOf("venues"),s=!i||-1<i.indexOf("hotspots");$.each(e,function(e,t){t.map_icon=t.hotspot?pe.Map.marker_types.HOTSPOT:pe.Map.marker_types.VENUE,a?(t.map_visibility=!0,t.hotspot&&!s&&(t.map_icon=pe.Map.marker_types.VENUE)):t.map_visibility=!(!t.hotspot||!s)})},pe.VenueSearcher.get_day_of_week_range=function(e,t){if(6<pe.days_between_dates(e,t))return[0,1,2,3,4,5,6];if(!t)return[e.getDay()];if(e===t)return[e.getDay()];var i=[],a=e.getDay(),s=t.getDay();for(i.push(a);6<(a+=1)&&(a=0),i.push(a),a!==s;);return i},pe.VenueSearcher.remove_event_tags=function(e){var i={};return $.each(e,function(e,t){"Event Type"!==e&&(i[e]=t)}),i},pe.VenueSearcher.venue_is_hotspot_in_date_range=function(e,t,i){if(t-i==0)return pe.VenueSearcher.venue_is_hotspot_on_date(e,t.getDay());var a=pe.VenueSearcher.get_day_of_week_range(t,i);return pe.array_match(e.hotspot_days,a)},pe.VenueSearcher.venue_is_hotspot_on_date=function(e,t){return-1<e.hotspot_days.indexOf(t)},pe.dependency_manager=new pe.DependencyManager,$(document).ready(function(){pe.install_easing(),$("html,body").stop(),window.search_page_link&&$("#wrapper").addClass("WithSearchLink"),pe.see_nearby_venues_link=$(".SeeNearbyVenues"),pe.see_photos_link_div=$(".SeeActivitiesPhotos"),pe.see_photos_link_div.hide(),pe.photos_map_tab=pe.new_convert_to_tabbed_pod($(".VenueMapTab"),{select:pe.venue_photos_map_tab_selected})[0],0!==window.activity_photos_count||window.venue_primary_photo||pe.photos_map_tab.tabs("select",1),pe.convert_to_rounded_corners(),setTimeout(function(){window.show_video_pod&&(pe.video_section=new pe.VideoSection($(".VideoSection"),360),pe.dependency_manager.set_flag("video_section"),pe.dependency_manager.call_when(["youtube_api","video_section"],function(){pe.video_section.create_player("youtube_player",window.video_id)})),setTimeout(function(){$(".CityReviewsEventsLink").click(pe.other_venues_clicked),$(".SwitchToPhotosLink").click(pe.switch_to_photos_link_clicked),$(".VideosLink").click(pe.activity_videos_link_clicked),pe.see_nearby_venues_link.click(pe.see_nearby_venues_clicked),pe.init_calendar_buttons(),pe.init_page_framework(function(){new pe.HelpModule2,0<window.activity_photos_count&&pe.ajax_loader.activity_photos.load({activity_id:window.activity_data.id},function(e){new pe.PhotoModule($(".PhotoSlideShow"),e,"width334","334","334x252","activity")}),pe.load_google_plus_script()})},10)},10)}),pe.activity_videos_link_clicked=function(){return 0===window.videos_count||pe.animated_scrolling($(".VideoSectionLinkTarget"),23),!1},pe.map_marker_clicked=function(e,t){switch(t.type){case pe.Map.marker_types.VENUE:case pe.Map.marker_types.EVENT:window.location.href="/venues/"+t.object_id}},pe.nearby_venues_loaded=function(e){pe.map.set_venues(e)},pe.nearby_events_loaded=function(e){pe.map.set_events(e)},pe.other_venues_clicked=function(){var e=pe.json_expander.expand_venue(window.venue_data),t=new pe.SearchConfiguration;t.add_filter("city",e.city_id),t.to_cookie(),window.location="/search"},pe.see_nearby_venues_clicked=function(){pe.photos_map_tab.tabs("select",1)},pe.switch_to_photos_link_clicked=function(){pe.photos_map_tab.tabs("select",0)},pe.venue_photos_map_tab_selected=function(e,t){if("#map_info"===$(t.tab).attr("href")){var i=pe.json_expander.expand_venue(window.venue_data);pe.map||(pe.map=new pe.Map($(".venue_map"),i.latitude,i.longitude,i.default_zoom_level,google.maps.MapTypeId.ROADMAP,{popups:[]}),pe.map.set_current_venue(i),pe.map.bind_event(pe.Map.events.MARKER_CLICKED,pe.map_marker_clicked)),pe.see_nearby_venues_link.hide(),pe.see_photos_link_div.show(),pe.ajax_loader.city_venues.load({city_id:i.city_id},pe.nearby_venues_loaded);var a=new Date,s=new Date(a.getFullYear(),a.getMonth()+6,a.getDate());pe.ajax_loader.city_events_on_date.load({city:i.city_id,start_date:pe.today_date_string(),end_date:pe.date_string(s)},pe.nearby_events_loaded)}else"#gal_info"===$(t.tab).attr("href")&&(pe.see_photos_link_div.hide(),pe.see_nearby_venues_link.show())},window.onYouTubePlayerAPIReady=function(){pe.dependency_manager.set_flag("youtube_api")};