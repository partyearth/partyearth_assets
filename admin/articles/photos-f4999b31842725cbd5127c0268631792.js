pe.CloseButton=function(b,a){pe.init_widget(this,b);this.close_button=b.find(".CloseButton");if("function"===typeof a)this.close_button.click(a);else switch(a){case pe.CloseButton.close_methods.REMOVE:this.close_button.click(this.callback(this.remove_container));break;case pe.CloseButton.close_methods.HIDE:this.close_button.click(this.callback(this.hide_container));break;default:alert("unknown value for 'close_method' parameter.")}};pe.CloseButton.close_methods={REMOVE:"REMOVE",HIDE:"HIDE"};
pe.CloseButton.events={CLOSED:"CloseButton_CLOSED"};pe.CloseButton.prototype.remove_container=function(){this.container.detach();this.fire_event(pe.CloseButton.events.CLOSED);this.container.remove();return!1};pe.CloseButton.prototype.hide_container=function(){this.fire_event(pe.CloseButton.events.CLOSED);this.container.hide();return!1};
pe.SingleSelectionAutocompleteField=function(b,a,c,g){pe.init_widget(this,b);this.close_button_callback=this.on_item_selected=null;this.autocomplete_data_or_url=a;this.input_field_name=c;this.container.html(this.html());this.dummy_input_field=this.container.find(".DummyInputField");this.autocomplete_input_field=this.container.find(".AutocompleteField");this.autocomplete_handler();this.selected_data_container=this.container.find(".SelectedValue");g&&this.set_field_value(g)};
pe.SingleSelectionAutocompleteField.events={SELECTED:"SingleSelectionAutocompleteField_SELECTED"};pe.SingleSelectionAutocompleteField.prototype.set_autocomplete_url=function(b){b&&(this.autocomplete_data_or_url=b,this.autocomplete_handler())};pe.SingleSelectionAutocompleteField.prototype.set_field_value=function(b){b&&0!==b.length&&(this.remove_dummy_row(),this.autocomplete_data_selected(b))};
pe.SingleSelectionAutocompleteField.prototype.add_dummy_row=function(){this.dummy_input_field||(this.dummy_input_field=$('<input class="DummyInputField"        type="hidden" name="'+this.input_field_name+'"       value="x_mock_single_value_x">'),this.autocomplete_input_field.after(this.dummy_input_field))};
pe.SingleSelectionAutocompleteField.prototype.autocomplete_data_selected=function(b){this.selected_data=b;this.remove_dummy_row();this.selected_data_container.append(this.selected_data_html(b.label,b.id,b.category));(new pe.CloseButton(this.selected_data_container.find(".SelectedInputData").last(),pe.CloseButton.close_methods.REMOVE)).bind_event(pe.CloseButton.events.CLOSED,this.callback(this.close_button_clicked));if(this.on_item_selected)this.on_item_selected(b)};
pe.SingleSelectionAutocompleteField.prototype.item_selected=function(b){this.on_item_selected=b};
pe.SingleSelectionAutocompleteField.prototype.autocomplete_handler=function(){this.autocomplete_input_field.autocomplete({source:this.autocomplete_data_or_url,minLength:1,focus:function(){return!1},close:this.callback(function(){this.autocomplete_input_field.val("")}),select:this.callback(function(b,a){var c=a.item;this.autocomplete_data_selected(c);this.fire_event(pe.SingleSelectionAutocompleteField.events.SELECTED,c.id)})}).data("autocomplete")._renderItem=function(b,a){a.display_label=a.category?
pe.templatize("{{label}} ({{category}})",a):a.label;return $("<li></li>").data("item.autocomplete",a).append(pe.templatize("<a>{{display_label}}</a>",a)).appendTo(b)}};pe.SingleSelectionAutocompleteField.prototype.clear_selected_data=function(){this.selected_data_container.html("");this.add_dummy_row()};
pe.SingleSelectionAutocompleteField.prototype.close_button_clicked=function(){0===this.selected_data_container.find(".SelectedInputData").length&&this.add_dummy_row();this.close_button_callback&&this.close_button_callback();this.autocomplete_input_field.show();this.autocomplete_input_field.focus()};pe.SingleSelectionAutocompleteField.prototype.display_close_button=function(){this.selected_data_container.find(".CloseButton").show()};pe.SingleSelectionAutocompleteField.prototype.hide_close_button=function(){this.selected_data_container.find(".CloseButton").hide()};
pe.SingleSelectionAutocompleteField.prototype.html=function(){return'<input class="AutocompleteField" type="text"><input class="DummyInputField" type="hidden" name="'+this.input_field_name+'" value="x_mock_single_value_x"><div class="SelectedValue"></div>'};pe.SingleSelectionAutocompleteField.prototype.remove_dummy_row=function(){this.dummy_input_field&&(this.dummy_input_field.remove(),this.dummy_input_field=null)};
pe.SingleSelectionAutocompleteField.prototype.replace_data_in_list=function(b){this.clear_selected_data();this.set_field_value(b)};pe.SingleSelectionAutocompleteField.prototype.selected_data_html=function(b,a,c){return'<div class="SelectedInputData selected_data">  <div class="CloseButton close_button">'+(c?b+"("+c+")":b)+'</div>  <input type="hidden" value="'+a+'" name="'+this.input_field_name+'"></div>'};
pe.SeeMoreButton=function(b,a){pe.init_widget(this,b);this.options={item_container_id:b.attr("rel"),initial_page_number:1,item_class:"Paginable",per_page:16,server_url:"index.ehtml",autoload:!0};$.extend(this.options,a);this.current_page_number=this.options.initial_page_number;this.item_container=$("#"+this.options.item_container_id);this.on_page_loaded=this.options.on_page_loaded;this.options.per_page=this.item_container.find("."+this.options.item_class).length||this.options.per_page;this.next_page_content=
"";this.container.click(this.callback(this.show_next_page));this.hide();this.options.autoload&&this.load_next_page()};pe.SeeMoreButton.prototype.load_next_page=function(b){var a=this.url()+"page="+(this.current_page_number+1)+"&per_page="+this.options.per_page;$.get(a,null,b?b:this.callback(this.set_next_page_content))};
pe.SeeMoreButton.prototype.set_next_page_content=function(b){this.next_page_content=b;this.refresh_photo_links();/\S/.test(b)?this.show():this.hide();if(this.on_page_loaded&&"function"===typeof this.on_page_loaded)this.on_page_loaded()};pe.SeeMoreButton.prototype.refresh_photo_links=function(){window.location.href.match(/events/)&&$(".Paginable a").each(function(){var b=pe.fetch_photo_id_from_url($(this).attr("href")+"");$(this).attr("href",window.location+"/"+b)})};
pe.SeeMoreButton.prototype.reset=function(){this.current_page_number=this.options.initial_page_number;this.container.show()};
pe.SeeMoreButton.prototype.show_next_page=function(){if("function"===typeof this.options.on_click)this.options.on_click();this.options.autoload?(this.item_container.append(this.next_page_content),this.current_page_number+=1,this.load_next_page()):this.load_next_page(this.callback(function(b){this.item_container.append(b);this.current_page_number+=1;this.container.toggle(!_.isEmpty(b));if(this.on_page_loaded&&"function"===typeof this.on_page_loaded)this.on_page_loaded()}));return!1};
pe.SeeMoreButton.prototype.url=function(){var b;b="function"===typeof this.options.server_url?this.options.server_url():this.options.server_url;return b+=/\?/.test(b)?"&":"?"};
(function(b){b.extend(b.fn,{swapClass:function(b,a){var e=this.filter("."+b);this.filter("."+a).removeClass(a).addClass(b);e.removeClass(b).addClass(a);return this},replaceClass:function(b,a){return this.filter("."+b).removeClass(b).addClass(a).end()},hoverClass:function(a){a=a||"hover";return this.hover(function(){b(this).addClass(a)},function(){b(this).removeClass(a)})},heightToggle:function(b,a){b?this.animate({height:"toggle"},b,a):this.each(function(){jQuery(this)[jQuery(this).is(":hidden")?
"show":"hide"]();a&&a.apply(this,arguments)})},heightHide:function(b,a){b?this.animate({height:"hide"},b,a):(this.hide(),a&&this.each(a))},prepareBranches:function(b){b.prerendered||(this.filter(":last-child:not(ul)").addClass(a.last),this.filter((b.collapsed?"":"."+a.closed)+":not(."+a.open+")").find(">ul").hide());return this.filter(":has(>ul)")},applyClasses:function(c,g){this.filter(":has(>ul):not(:has(>a))").find(">span").unbind("click.treeview").bind("click.treeview",function(a){this==a.target&&
g.apply(b(this).next())}).add(b("a",this)).hoverClass();if(!c.prerendered){this.filter(":has(>ul:hidden)").addClass(a.expandable).replaceClass(a.last,a.lastExpandable);this.not(":has(>ul:hidden)").addClass(a.collapsable).replaceClass(a.last,a.lastCollapsable);var e=this.find("div."+a.hitarea);e.length||(e=this.prepend('<div class="'+a.hitarea+'"/>').find("div."+a.hitarea));e.removeClass().addClass(a.hitarea).each(function(){var a="";b.each(b(this).parent().attr("class").split(" "),function(){a+=this+
"-hitarea "});b(this).addClass(a)})}this.find("div."+a.hitarea).click(g)},treeview:function(c){function g(c,j){function d(d){return function(){e.apply(b("div."+a.hitarea,c).filter(function(){return d?b(this).parent("."+d).length:!0}));return!1}}b("a:eq(0)",j).click(d(a.collapsable));b("a:eq(1)",j).click(d(a.expandable));b("a:eq(2)",j).click(d())}function e(){b(this).parent().find(">.hitarea").swapClass(a.collapsableHitarea,a.expandableHitarea).swapClass(a.lastCollapsableHitarea,a.lastExpandableHitarea).end().swapClass(a.collapsable,
a.expandable).swapClass(a.lastCollapsable,a.lastExpandable).find(">ul").heightToggle(c.animated,c.toggle);c.unique&&b(this).parent().siblings().find(">.hitarea").replaceClass(a.collapsableHitarea,a.expandableHitarea).replaceClass(a.lastCollapsableHitarea,a.lastExpandableHitarea).end().replaceClass(a.collapsable,a.expandable).replaceClass(a.lastCollapsable,a.lastExpandable).find(">ul").heightHide(c.animated,c.toggle)}function m(){var a=[];h.each(function(c,d){a[c]=b(d).is(":has(>ul:visible)")?1:0});
b.cookie(c.cookieId,a.join(""),c.cookieOptions)}function k(){var a=b.cookie(c.cookieId);if(a){var j=a.split("");h.each(function(a,c){b(c).find(">ul")[parseInt(j[a])?"show":"hide"]()})}}c=b.extend({cookieId:"treeview"},c);if(c.toggle){var n=c.toggle;c.toggle=function(){return n.apply(b(this).parent()[0],arguments)}}this.data("toggler",e);this.addClass("treeview");var h=this.find("li").prepareBranches(c);switch(c.persist){case "cookie":var j=c.toggle;c.toggle=function(){m();j&&j.apply(this,arguments)};
k();break;case "location":var f=this.find("a").filter(function(){return this.href.toLowerCase()==location.href.toLowerCase()});f.length&&(f=f.addClass("selected").parents("ul, li").add(f.next()).show(),c.prerendered&&f.filter("li").swapClass(a.collapsable,a.expandable).swapClass(a.lastCollapsable,a.lastExpandable).find(">.hitarea").swapClass(a.collapsableHitarea,a.expandableHitarea).swapClass(a.lastCollapsableHitarea,a.lastExpandableHitarea))}h.applyClasses(c,e);c.control&&(g(this,c.control),b(c.control).show());
return this}});b.treeview={};var a=b.treeview.classes={open:"open",closed:"closed",expandable:"expandable",expandableHitarea:"expandable-hitarea",lastExpandableHitarea:"lastExpandable-hitarea",collapsable:"collapsable",collapsableHitarea:"collapsable-hitarea",lastCollapsableHitarea:"lastCollapsable-hitarea",lastCollapsable:"lastCollapsable",lastExpandable:"lastExpandable",last:"last",hitarea:"hitarea"}})(jQuery);
(function(b){var a={topSpacing:0,bottomSpacing:0,className:"is-sticky",wrapperClassName:"sticky-wrapper",center:!1,getWidthFrom:""},c=b(window),g=b(document),e=[],m=c.height(),k=function(){for(var a=c.scrollTop(),f=g.height(),l=f-m,l=a>l?l-a:0,h=0;h<e.length;h++){var d=e[h],i=d.stickyWrapper.offset().top-d.topSpacing-l;a<=i?null!==d.currentTop&&(d.stickyElement.css("position","").css("top",""),d.stickyElement.parent().removeClass(d.className),d.currentTop=null):(i=f-d.stickyElement.outerHeight()-
d.topSpacing-d.bottomSpacing-a-l,i=0>i?i+d.topSpacing:d.topSpacing,d.currentTop!=i&&(d.stickyElement.css("position","fixed").css("top",i),"undefined"!==typeof d.getWidthFrom&&d.stickyElement.css("width",b(d.getWidthFrom).width()),d.stickyElement.parent().addClass(d.className),d.currentTop=i))}},n=function(){m=c.height()},h={init:function(c){var f=b.extend(a,c);return this.each(function(){var a=b(this);stickyId=a.attr("id");wrapper=b("<div></div>").attr("id",stickyId+"-sticky-wrapper").addClass(f.wrapperClassName);
a.wrapAll(wrapper);f.center&&a.parent().css({width:a.outerWidth(),marginLeft:"auto",marginRight:"auto"});"right"==a.css("float")&&a.css({"float":"none"}).parent().css({"float":"right"});var c=a.parent();c.css("height",a.outerHeight());e.push({topSpacing:f.topSpacing,bottomSpacing:f.bottomSpacing,stickyElement:a,currentTop:null,stickyWrapper:c,className:f.className,getWidthFrom:f.getWidthFrom})})},update:k};window.addEventListener?(window.addEventListener("scroll",k,!1),window.addEventListener("resize",
n,!1)):window.attachEvent&&(window.attachEvent("onscroll",k),window.attachEvent("onresize",n));b.fn.sticky=function(a){if(h[a])return h[a].apply(this,Array.prototype.slice.call(arguments,1));if(typeof a==="object"||!a)return h.init.apply(this,arguments);b.error("Method "+a+" does not exist on jQuery.sticky")};b(function(){setTimeout(k,0)})})(jQuery);
pe.PhotoBloodhound=function(b){pe.init_widget(this,b);this.base_url="/admin/articles/photos.ehtml";this.filters_form=this.container.find(".Filters");this.filters_form.submit(function(){return!1});this.form=this.container.find(".PhotosForm");this.form.parent().hide();this.hider=this.container.find(".Hider");this.hider.click(this.callback(this.hider_clicked));this.last_checked=null;this.reset_button=this.container.find(".ResetButton");this.reset_button.click(this.callback(this.reset));this.search_button=
this.container.find(".SearchButton");this.search_button.click(this.callback(this.search_button_clicked));this.subtagger=this.container.find(".Subtagger");this.see_more_button=new pe.SeeMoreButton(this.container.find(".ShowMoreButton"),{autoload:!1,on_click:this.callback(this.init_loading),on_page_loaded:this.callback(this.reset_ui),server_url:this.callback(this.url)});this.container.find(".TagsTree").treeview({collapsed:!0});this.container.find(".Searcher").sticky({topSpacing:0});this.filters_form.find("input, textarea, select").change(this.callback(function(){this.search_button.removeClass("disabled").removeAttr("disabled")}));
this.filters_form.find(".FilterTrigger").click(function(a){$(a.currentTarget).toggleClass("blue_text");$(a.currentTarget).parent(".Filter").find(".FilterOptions").toggle()});this.container.find(".DeselectAllButton").click(this.callback(function(){this.form[0].reset();this.update_counters()}));this.form.find("input").live("click",this.callback(this.photo_checked))};
pe.PhotoBloodhound.prototype.init_loading=function(){this.search_button.addClass("disabled").attr("disabled","disabled");this.container.find(".Spinner").removeClass("hidden");this.form.parent().show()};
pe.PhotoBloodhound.prototype.hider_clicked=function(){this.filters_form.toggle(!this.filters_form.is(":visible"));this.container.find(".sticky-wrapper").css("height",this.container.find(".Searcher").outerHeight()+"px");if(this.filters_form.is(":visible"))this.container.find(".Debugger").html("Filters: ");else{var b="Filters: "+this.filters_form.serialize(),b=b.replace(/utf8=[^&]+(&|$)/,""),b=b.replace(/authenticity_token=[^&]+(&|$)/,""),b=b.replace(/&/g,", "),b=decodeURIComponent(b),b=b.replace(/(\w+)\[\]=/g,
"<b>$1</b>:&nbsp;");this.container.find(".Debugger").html(b)}return!1};pe.PhotoBloodhound.prototype.photo_checked=function(b){if(this.last_checked&&b.shiftKey)for(var a=this.form.find("input"),c=a.index(this.last_checked),g=a.index(b.target),e=Math.min(c,g),c=Math.max(c,g);e<c;e++)this.last_checked.is(":checked")?$(a[e]).attr("checked","checked"):$(a[e]).removeAttr("checked");this.last_checked=$(b.target);this.update_counters()};
pe.PhotoBloodhound.prototype.search_button_clicked=function(){this.init_loading();this.form.html("");$.get(this.base_url,this.serialize(),this.callback(function(b){this.form.html(b);this.see_more_button.reset();this.reset_ui()}));return!1};pe.PhotoBloodhound.prototype.reset=function(){this.filters_form[0].reset();this.search_button.removeClass("disabled").removeAttr("disabled");return!1};pe.PhotoBloodhound.prototype.reset_ui=function(){this.container.find(".Spinner").addClass("hidden");this.update_counters()};
pe.PhotoBloodhound.prototype.serialize=function(){var b;this.subtagger.is(":checked")?(this.container.find(".TagsTree>.Tag .Tag input:checked").addClass("Checked").removeAttr("checked"),b=this.filters_form.serialize(),this.filters_form.find(".Checked").removeClass("Checked").attr("checked","checked")):b=this.filters_form.serialize();return b};pe.PhotoBloodhound.prototype.update_counters=function(){this.container.find(".TotalCount").html(this.form.find("input[type=checkbox]").length);this.container.find(".SelectedCount").html(this.form.find("input:checked").length)};
pe.PhotoBloodhound.prototype.url=function(){return this.base_url+"?"+this.serialize()};
$(document).ready(function(){pe.bloodhound=new pe.PhotoBloodhound($(".Bloodhound"));pe.autocomplete=new pe.SingleSelectionAutocompleteField($(".DestinationAutocomplete"),"/api/articles/autocomplete","article_id",[]);$(".CopyPhotosButton").click(function(b){var a=$(b.target);a.addClass("disabled");var b=$(".PhotosForm").serialize(),c=$(".SelectedInputData > input[name=article_id]").val();$.post("/admin/articles/photos/copy",b+"&article_id="+c).success(function(){a.removeClass("disabled")})});$(".Copier").sticky({topSpacing:0});
pe.init_page_framework()});
