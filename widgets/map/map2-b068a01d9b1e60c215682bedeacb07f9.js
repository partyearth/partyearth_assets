pe.mouse_position={};pe.mouse_position.x=0;pe.mouse_position.y=0;pe.mouse_position.on_mouse_move=function(a){pe.mouse_position.x=a.pageX;pe.mouse_position.y=a.pageY};pe.mouse_position.track=function(){$("body").mousemove(pe.mouse_position.on_mouse_move)};
pe.Map2=function(a,b){pe.init_widget(this,a);this.options=b;this.options.bubbles=this.options.bubbles||"ALL";this.options.min_zoom=this.options.min_zoom||11;this.zoom=b.zoom||10;this.map=new google.maps.Map(a[0],{center:new google.maps.LatLng(b.latitude,b.longitude),mapTypeControlOptions:{style:google.maps.MapTypeControlStyle.DROPDOWN_MENU},mapTypeId:b.mapTypeId,minZoom:b.min_zoom,navigationControlOptions:{style:google.maps.NavigationControlStyle.SMALL},scrollwheel:b.scrollwheel,zoom:b.zoom});var c=
new google.maps.OverlayView;c.draw=function(){};c.setMap(this.map);this.overlay=c;pe.mouse_position.track();this.tooltip_div=$('<div class="new_map_tooltip" style="display:none;"></div>');$("body").append(this.tooltip_div);this.infopopup_div=$('<div class="map_infowindow" style="display:none;"></div>');$("body").append(this.infopopup_div);this.markers=[]};pe.Map2.events={MARKER_CLICKED:"Map_MARKER_CLICKED",MARKER_HOVERED:"Map_MARKER_HOVERED",MARKER_BLURRED:"Map_MARKER_BLURRED"};
pe.Map2.marker_types={EVENT:"EVENT",USER_LOCATION:"USER_LOCATION",VENUE:"VENUE"};
pe.Map2.prototype.add_marker=function(a){var b=new google.maps.Marker({position:new google.maps.LatLng(a.latitude,a.longitude),map:this.map,icon:a.icon,cursor:"pointer",zIndex:a.z_index});b.bubble_html=a.bubble_html||"";b.popup_html=a.popup_html||"";b.type=a.type;b.object_id=a.object_id;b.z_index=a.z_index;b.clicked=!1;b.hovered=!1;var c=this;google.maps.event.addListener(b,"click",function(){c.fire_event(pe.Map2.events.MARKER_CLICKED,this)});google.maps.event.addListener(b,"mouseover",function(){c.fire_event(pe.Map2.events.MARKER_HOVERED,
this)});google.maps.event.addListener(b,"mouseout",function(){c.fire_event(pe.Map2.events.MARKER_BLURRED,this)});this.markers.push(b)};pe.Map2.prototype.find_marker_by_id=function(a){return _.detect(this.markers,function(b){return b.object_id===a})};pe.Map2.prototype.get_center_coordinates=function(){var a=this.map.getCenter();return{latitude:a.lat(),longitude:a.lng()}};
pe.Map2.prototype.highlight_marker=function(a){_.each(this.markers,function(a){this.shade_marker(a)},this);a.setIcon(pe.Map2.icon_path(a.type,a.object_id,!0));a.setZIndex(1E3)};pe.Map2.prototype.shade_marker=function(a){a.setIcon(pe.Map2.icon_path(a.type,a.object_id));a.setZIndex(a.z_index)};
pe.Map2.icon_path=function(a,b,c){if(a===pe.Map2.marker_types.USER_LOCATION)return"http://www.partyearth.com/assets/map/location.png?"+pe.assets_timestamp();a={type:a.toLowerCase(),id:pe.Map2.format_marker_id(b),timestamp:pe.assets_timestamp()};return pe.templatize(c?"http://cdn.partyearth.com/assets/map/pins/selected/map/{{id}}.png?{{timestamp}}":"http://cdn.partyearth.com/assets/map/pins/{{type}}/map/{{id}}.png?{{timestamp}}",a)};
pe.Map2.format_marker_id=function(a){return 3<a.length?"0000":"0000".substr(0,4-a.length)+a};pe.Map2.prototype.locate=function(a,b){(new google.maps.Geocoder).geocode({address:a},this.callback(function(a,e){if(e==google.maps.GeocoderStatus.OK){var d=a[0].geometry.location;this.map.setCenter(d);b&&b.success&&b.success(d)}else b&&b.fail&&b.fail()}))};pe.Map2.prototype.marker_position_on_map=function(a){var b=this.overlay.getProjection(),a=a.getPosition();return b.fromLatLngToContainerPixel(a)};
pe.Map2.prototype.marker_position_on_page=function(a){a=this.marker_position_on_map(a);return{x:this.container.offset().left+a.x,y:this.container.offset().top+a.y}};pe.Map2.marker_type=function(a){switch(a){case "EVENT":return pe.Map2.marker_types.EVENT;case "VENUE":return pe.Map2.marker_types.VENUE;case "USER_LOCATION":return pe.Map2.marker_types.USER_LOCATION;default:return alert("Unknown marker type")}};
pe.Map2.prototype.set_map_to_fit_markers=function(){if(this.markers.length){var a=new google.maps.LatLngBounds;_.each(this.markers,function(b){a.extend(b.getPosition())},this);this.map.setOptions({minZoom:null});this.map.fitBounds(a);var b=this.map.getZoom(),c=this.zoom;17<b&&this.map.setZoom(c);b>this.options.min_zoom&&(b=this.options.min_zoom);this.map.setOptions({minZoom:b})}};
pe.Map2.prototype.set_objects=function(a){$.each(this.markers,this.callback(function(a,c){c.setMap(null)}));this.markers=[];a.length&&($.each(a,this.callback(function(b,c){if(c.lat&&c.lng){var e=pe.Map2.marker_type(c.type),d=c.id;this.add_marker({type:e,icon:pe.Map2.icon_path(e,d),object_id:d,latitude:c.lat,longitude:c.lng,bubble_html:c.bubble_html,popup_html:c.popup_html,z_index:a.length-b})}})),this.set_map_to_fit_markers())};
