pe.GeocodeErrorDialog=function(a){pe.init_widget(this,null);this.container=$(this.html(a));this.container.appendTo("body");this.container.dialog({title:"Geo system error",modal:!0,resizable:!1,width:300,buttons:{Ok:function(){$(this).remove()}}})};pe.GeocodeErrorDialog.prototype.html=function(a){return"<div>The geocoder returned the error '"+a+"'. Please try again later.</div>"};
pe.GeocodeNoResultsDialog=function(){pe.init_widget(this,null);this.container=$(this.html());this.container.appendTo("body");this.container.dialog({title:"We were unable to find the address you entered.",modal:!0,resizable:!1,width:300,buttons:{Ok:function(){$(this).remove()}}})};pe.GeocodeNoResultsDialog.prototype.html=function(){return"<div>Please try again.</div>"};
pe.MultipleLocationResultsDialog=function(a,b){pe.init_widget(this,null);this.success_callback=b;this.results=a;this.dialog_div=$(this.html(a));this.dialog_div.appendTo("body");this.dialog_div.click(this.callback(this.result_clicked));this.dialog_div.dialog({width:350,modal:!0,title:'The search returned <span class="blue_text">'+this.results.length+" results</span>. Please click on your choice.",resizable:!1,buttons:{Cancel:function(){$(this).remove()}}})};
pe.MultipleLocationResultsDialog.prototype.html=function(a){var b='<div class="ContentContainer">';$.each(a,function(a,d){b+='<div class="Choice" data_position="'+a+'">'+d.formatted_address+"</div>"});return b+="</div>"};pe.MultipleLocationResultsDialog.prototype.result_clicked=function(a){a=$(a.target).closest(".Choice").attr("data_position");this.dialog_div.remove();this.success_callback(this.results[a])};pe.CallbackHandler=function(){this.callbacks={}};
pe.CallbackHandler.prototype.add=function(a,b){this.callbacks[a]||(this.callbacks[a]=[]);this.callbacks[a].push(b)};pe.CallbackHandler.prototype.call=function(a,b){var c=Array.prototype.slice.call(arguments,1);if(this.callbacks[a])return _.each(this.callbacks[a],function(a){a.apply(null,c)}),!0};pe.TabsSection=function(a,b){pe.init_widget(this,a);this.selected_tab="";this.tabs=this.container.find("a[rel]");this.tabs.click(this.callback(this.tab_clicked));this.select_tab(b||"all_results")};
pe.TabsSection.events={CHANGED:"TabsSection_CHANGED"};pe.TabsSection.tabs={ALL_RESULTS:"all_results",THINGS_TO_DO:"things_to_do",BARS_AND_CLUBS:"bars_and_clubs",RESTAURANTS:"restaurants",EVENT_VENUES:"event_venues",EVENTS:"events",ENTERTAINERS:"entertainers",TEAMS:"teams"};pe.TabsSection.venue_tabs={ALL_RESULTS:"all_results",THINGS_TO_DO:"things_to_do",BARS_AND_CLUBS:"bars_and_clubs",RESTAURANTS:"restaurants",EVENT_VENUES:"event_venues"};pe.TabsSection.tab_names=_.uniq(_.values(pe.TabsSection.tabs));
pe.TabsSection.prototype.add_search_configuration=function(a){a.add_filter("category",this.get_selected_tab_name())};pe.TabsSection.prototype.get_selected_tab_name=function(){return this.selected_tab};pe.TabsSection.prototype.read_search_configuration=function(a){this.select_tab(a.filter_value("category")||"all_results")};
pe.TabsSection.prototype.select_tab=function(a){a=(a||"").replace(/-/g,"_");_.contains(pe.TabsSection.tab_names,a)||(a="all_results");this.selected_tab=a;this.tabs.removeClass("selected");this.tabs.filter("[rel="+a+"]").addClass("selected")};pe.TabsSection.prototype.tab_clicked=function(a){a=$(a.currentTarget);a.hasClass("disabled")||(a=a.attr("rel")+"",this.selected_tab!=a&&(this.select_tab(a),pe.fire_global_event(pe.TabsSection.events.CHANGED,a)))};
pe.TabsSection.prototype.update_tab_counters=function(a){this.tabs.addClass("disabled");_.each(pe.TabsSection.tab_names,this.callback(function(b){var c=this.tabs.filter("[rel="+b+"]"),b=a[b]||0;0!==b&&c.removeClass("disabled");c.find(".Counter").html("("+b+")")}))};
pe.StandardFilter=function(a,b,c,d){pe.init_widget(this,a);this.id=b;this.title=d||this.id;this.facets={};this.selection_facets={};this.selected_values=[];this.visible_tabs=c;this.callbacks=new pe.CallbackHandler;this.all_container=a.find(".All");this.all_container.addClass("hidden");setTimeout(this.callback(function(){this.all_container.treeview({collapsed:!0})}),0);this.summary_container=a.find(".Summary");this.more_link=this.container.find(".More");this.more_link.click(this.callback(this.on_more_link_clicked));
this.filter_title_container=this.container.find(".FilterTitle");this.filter_title_container.click(this.callback(this.on_more_link_clicked));this.view_status=pe.StandardFilter.view_statuses.SUMMARY;this.all_inputs().live("change",this.callback(this.on_checkbox_changed));this.summary_inputs().live("change",this.callback(this.on_checkbox_changed));pe.bind_global_event(pe.TabsSection.events.CHANGED,this.callback(this.on_tab_changed))};pe.StandardFilter.SUMMARY_LENGTH=4;
pe.StandardFilter.callbacks={AFTER_CHECKBOX_CHANGED:"standard_filter_after_checkbox_changed",AFTER_UPDATE_SUMMARY:"after_update_summary",BEFORE_UPDATE_SUMMARY:"before_update_summary"};pe.StandardFilter.events={CHANGED:"StandardFilter_CHANGED"};pe.StandardFilter.view_statuses={HIDDEN:1,SUMMARY:2,ALL:3};pe.StandardFilter.prototype.add_search_configuration=function(a){a.filter_value("result_types");!this.is_nothing_checked()&&!this.is_all_checked()&&a.add_filter(this.id,this.filter_values())};
pe.StandardFilter.prototype.filter_values=function(){return _.union(_.map(this.selected_values,function(a){return this.input_value(a)},this))};pe.StandardFilter.prototype.input_value=function(a){var b=[a],a=$("#tag_"+a).parents("ul").parents("li").children(".Input");0<a.length&&(b=b.concat(this.input_value("__parent_tag__"+a.val())));return b};pe.StandardFilter.prototype.all_inputs=function(){return this.all_container.find(".Input")};pe.StandardFilter.prototype.summary_inputs=function(){return this.summary_container.find(".Input")};
pe.StandardFilter.prototype.select=function(a){this.selected_values=_.union(this.selected_values,a)};pe.StandardFilter.prototype.unselect=function(a){this.selected_values=_.without(this.selected_values,a)};pe.StandardFilter.prototype.is_selected=function(a){return _.include(this.selected_values,a)};pe.StandardFilter.prototype.check=function(a){this.select(a);$("#tag_"+a).attr("checked","checked");$("#summary_tag_"+a).attr("checked","checked")};
pe.StandardFilter.prototype.fix_tree_expander=function(){_.each(this.all_container.find("li:not(.Custom,.hidden)"),function(a){var b=$(a).find("li");0!==b.length&&(0===b.filter("li:not(.hidden)").length?$(a).removeClass("collapsable expandable").children(".expandable-hitarea").hide():$(a).hasClass("expandable")||$(a).addClass("expandable").children(".expandable-hitarea").show())})};pe.StandardFilter.prototype.get_filter_field=function(a){return $("#tag_"+a).closest("li")};
pe.StandardFilter.prototype.get_visible_tabs=function(){return this.visible_tabs};pe.StandardFilter.prototype.is_all_checked=function(){return this.all_inputs().length===this.selected_values.length};pe.StandardFilter.prototype.is_any_checked=function(){return 0<this.selected_values.length};pe.StandardFilter.prototype.is_many_items_checked=function(){return 1<this.selected_values.length};pe.StandardFilter.prototype.is_only_one_item_checked=function(){return 1===this.selected_values.length};
pe.StandardFilter.prototype.is_checked=function(a){return _.include(this.selected_values,a)};pe.StandardFilter.prototype.is_nothing_checked=function(){return 0===this.selected_values.length};
pe.StandardFilter.prototype.on_checkbox_changed=function(a){var a=$(a.target).closest(".Input"),b=a.val().toString();this.is_selected(b)?this.uncheck(b):this.check(b);pe.fire_global_event(pe.StandardFilter.events.CHANGED);setTimeout(this.callback(function(){this.update_summary()}),1);this.callbacks.call(pe.StandardFilter.callbacks.AFTER_CHECKBOX_CHANGED,a)};
pe.StandardFilter.prototype.on_dialog_close_button_clicked=function(){this.all_container.dialog("destroy");this.all_container.addClass("hidden");this.view_status=pe.StandardFilter.view_statuses.SUMMARY};
pe.StandardFilter.prototype.on_more_link_clicked=function(){this.all_container.removeClass("hidden");var a=this.all_container.dialog({title:this.title,modal:!0,resizable:!1,buttons:{Close:this.callback(this.on_dialog_close_button_clicked)}});a.parent().css({position:"fixed"}).end();a.find(".Input").unbind("change").bind("change",this.callback(this.on_checkbox_changed));this.view_status=pe.StandardFilter.view_statuses.ALL};
pe.StandardFilter.prototype.on_tab_changed=function(a,b){_.include(this.visible_tabs,b)?this.show():this.hide()};pe.StandardFilter.prototype.read_search_configuration=function(a){this.selected_values=_.compact(_.union([],a.filter_value(this.id)));this.selected_values=_.reject(this.selected_values,function(a){return a.match(/^__parent_tag__/g)});_.each(this.selected_values,function(a){this.check(a)},this);this.update_summary()};pe.StandardFilter.prototype.replace_filter_field=function(a,b){this.get_filter_field(a).html(b)};
pe.StandardFilter.prototype.reset=function(){_.each(this.selected_values,function(a){this.uncheck(a)},this);setTimeout(this.callback(function(){this.update_summary()}),1)};pe.StandardFilter.prototype.uncheck=function(a){this.unselect(a);$("#tag_"+a).removeAttr("checked");$("#summary_tag_"+a).removeAttr("checked")};
pe.StandardFilter.prototype.update_more_button=function(){var a=this.all_container.find(".Top:not(.hidden)");a.length>pe.StandardFilter.SUMMARY_LENGTH||0<a.find(".Child").length?(this.more_link.removeClass("hidden"),this.filter_title_container.removeClass("no_hover"),this.filter_title_container.click(this.callback(this.on_more_link_clicked))):(this.more_link.addClass("hidden"),this.filter_title_container.addClass("no_hover").unbind("click"))};
pe.StandardFilter.prototype.update_ui=function(){0<this.all_container.find(">.Top:not(.hidden)").length?(this.fix_tree_expander(),this.update_summary()):this.hide()};pe.StandardFilter.prototype.free_summary_slots=function(){return pe.StandardFilter.SUMMARY_LENGTH-this.summary_container.children("li").length};
pe.StandardFilter.prototype.update_summary=function(){this.summary_container.empty();this.callbacks.call(pe.StandardFilter.callbacks.BEFORE_UPDATE_SUMMARY);var a=_.first(this.selected_values,this.free_summary_slots());this.add_tags_to_summary(a);var b=this.free_summary_slots();if(0<b)for(var a=_.map(_.difference(this.top_tags(),a),function(a){return $("#tag_"+a)}),c=0;0<b&&c<a.length;c++){var d=a[c].parent().filter("li.Top:not(.Custom)");0<d.length&&(this.add_items_to_summary(d.clone()),b--)}this.update_more_button();
this.callbacks.call(pe.StandardFilter.callbacks.AFTER_UPDATE_SUMMARY)};pe.StandardFilter.prototype.top_tags=function(){var a=_.sortBy(_.values(this.selection_facets),function(a){return 1E4-a},this),a=_.compact(_.union(_.map(a,function(a){return _.map(this.selection_facets,function(b,e){if(b==a)return e})},this))),b=_.difference(_.keys(this.facets),a);return _.union(a,b)};
pe.StandardFilter.prototype.set_facets=function(a){this.facets=a;this.all_container.find("li:not(.Custom)").addClass("hidden");_.each(_.keys(this.facets),function(a){this.get_filter_field(a).removeClass("hidden")},this);_.each(this.selected_values,function(a){this.get_filter_field(a).removeClass("hidden")},this)};pe.StandardFilter.prototype.set_selection_facets=function(a){this.selection_facets=a;setTimeout(this.callback(function(){this.update_ui()}),1)};
pe.StandardFilter.prototype.add_tags_to_summary=function(a){_.each(a,function(a){a=$("#tag_"+a).parent("li").clone();a.hasClass("Custom")||this.summary_container.append(this.convert_to_summary_item(a,!0))},this)};pe.StandardFilter.prototype.add_items_to_summary=function(a){_.each(a,function(a){this.summary_container.append(this.convert_to_summary_item($(a),!0))},this)};
pe.StandardFilter.prototype.convert_to_summary_item=function(a,b){var c=a.find(".Input"),d="summary_"+c.attr("id");c.attr("id",d);a.find("label").attr("for",d);b&&a.find("ul").remove();return a};
pe.WhereFilter=function(a,b){pe.init_widget(this,a);this.map=b;this.custom_location=null;this.standard_filter=new pe.StandardFilter(a,"where",[pe.TabsSection.tabs.ALL_RESULTS,pe.TabsSection.tabs.THINGS_TO_DO,pe.TabsSection.tabs.BARS_AND_CLUBS,pe.TabsSection.tabs.RESTAURANTS,pe.TabsSection.tabs.EVENT_VENUES,pe.TabsSection.tabs.EVENTS,pe.TabsSection.tabs.ENTERTAINERS,pe.TabsSection.tabs.TEAMS]);this.fake_input=this.standard_filter.all_container.find(".FakeInput");this.fake_input.change(this.callback(this.custom_checkbox_changed));
this.custom_location_label=this.standard_filter.container.find(".CustomLocationLabel");this.custom_location_label.html(pe.WhereFilter.DEFAULT_LOCATION_LABEL);this.custom_location_label.bind("click",this.callback(this.custom_label_clicked));this.custom_location_results=[];this.location_popup=$(".LocationPopup");this.location_popup.find(".Cancel").click(this.callback(this.popup_cancel_clicked));this.location_popup.find(".Close").click(this.callback(this.popup_cancel_clicked));this.location_popup.find(".Done").click(this.callback(this.popup_done_clicked));
this.location_popup.find(".CustomLocationInput").keypress(this.callback(this.popup_key_pressed));this.standard_filter.callbacks.add("before_update_summary",this.callback(function(){this.standard_filter.summary_container.append(this.standard_filter.convert_to_summary_item($(this.standard_filter.all_container.find("li.Custom")[0]).clone(!0)))}));pe.bind_global_event(pe.MapSection.events.PINS_UPDATED,this.callback(this.on_map_pins_updated));this.location_popup.click(this.callback(this.popup_clicked));
$(document).click(this.callback(this.popup_cancel_clicked))};pe.WhereFilter.DEFAULT_LOCATION_LABEL="Enter Your Location";pe.WhereFilter.DEFAULT_TRUNCATION_LIMIT=25;pe.WhereFilter.POPUP_OFFSET_LEFT=0;pe.WhereFilter.POPUP_OFFSET_TOP=20;
pe.WhereFilter.events={CUSTOM_LABEL_CHANGED:"WhereFilter_custom_location_label_changed",EMPTY_SELECTION_TRIGGERED:"WhereFilter_empty_selection_triggered",MULTIPLE_SELECTION_TRIGGERED:"WhereFilter_multiple_selection_triggered",CUSTOM_SELECTION_TRIGGERED:"WhereFilter_custom_selection_triggered",SINGLE_SELECTION_TRIGGERED:"WhereFilter_single_selection_triggered"};
pe.WhereFilter.prototype.add_search_configuration=function(a){this.standard_filter.add_search_configuration(a);pe.array_contains(a.filter_value("where"),"custom-address")&&this.custom_location&&(a.add_filter("lat",this.custom_location.latitude),a.add_filter("lng",this.custom_location.longitude),a.add_filter("address",this.custom_location.address))};pe.WhereFilter.prototype.clear_results_list=function(){this.location_popup.find(".Title").empty();this.location_popup.find(".Results").empty()};
pe.WhereFilter.prototype.custom_checkbox_changed=function(a){var a=$(a.target),b=this.checkbox_is_checked(a);this.toggle_fake_inputs(b);this.custom_location?(b?this.standard_filter.check("custom-address"):this.standard_filter.uncheck("custom-address"),pe.fire_global_event(pe.StandardFilter.events.CHANGED)):b?this.show_location_popup(a):(this.location_popup.hide(),this.clear_results_list())};pe.WhereFilter.prototype.checkbox_is_checked=function(a){return a.is(":checked")};
pe.WhereFilter.prototype.custom_label_clicked=function(a){this.show_location_popup($(a.target).siblings(".FakeInput"));return!1};
pe.WhereFilter.prototype.custom_saved=function(a){""===$.trim(a)?(this.custom_location=null,this.standard_filter.uncheck("custom-address"),this.fake_input.attr("checked",!1),this.location_popup.hide(),this.update_custom_label(pe.WhereFilter.DEFAULT_LOCATION_LABEL)):(this.update_custom_label(a),(new google.maps.Geocoder).geocode({address:a,bounds:this.map.map.getBounds()},this.callback(this.geocode_success)))};
pe.WhereFilter.prototype.geocode_success=function(a,b){this.custom_location_results=a;switch(b){case google.maps.GeocoderStatus.OK:if(1===a.length)this.on_custom_location_selected(a[0]);else this.show_multiple_location_results();break;case google.maps.GeocoderStatus.ZERO_RESULTS:this.show_geocode_error();this.revert_custom_address();break;default:this.show_geocode_error(b),this.revert_custom_address()}};pe.WhereFilter.prototype.get_visible_tabs=function(){return this.standard_filter.get_visible_tabs()};
pe.WhereFilter.prototype.is_nothing_checked=function(){return this.standard_filter.is_nothing_checked()};pe.WhereFilter.prototype.multiple_location_results_list_html=function(){var a="";$.each(this.custom_location_results,function(b,c){a+='<div class="Item" data_position="'+b+'">'+c.formatted_address+"</div>"});return a};pe.WhereFilter.prototype.multiple_location_results_title_html=function(a){return'The search returned <span class="blue_text">'+a+" results</span>. Please click on your choice."};
pe.WhereFilter.prototype.on_state_changed=function(){this.standard_filter.is_nothing_checked()?pe.fire_global_event(pe.WhereFilter.events.EMPTY_SELECTION_TRIGGERED):this.standard_filter.is_many_items_checked()?pe.fire_global_event(pe.WhereFilter.events.MULTIPLE_SELECTION_TRIGGERED):this.standard_filter.is_checked("custom")?pe.fire_global_event(pe.WhereFilter.events.CUSTOM_SELECTION_TRIGGERED):pe.fire_global_event(pe.WhereFilter.events.SINGLE_SELECTION_TRIGGERED);pe.fire_global_event(pe.StandardFilter.events.CHANGED)};
pe.WhereFilter.prototype.on_map_pins_updated=function(){this.custom_location&&this.standard_filter.is_checked("custom-address")&&this.update_custom_location_pin()};pe.WhereFilter.prototype.on_tab_changed=function(a,b){this.standard_filter.on_tab_changed(a,b)};
pe.WhereFilter.prototype.on_custom_location_selected=function(a){this.location_popup.find(".ErrorMessage").empty();this.location_popup.hide();this.map.map.fitBounds(a.geometry.viewport);this.custom_location={latitude:a.geometry.location.lat(),longitude:a.geometry.location.lng(),address:a.formatted_address};this.update_custom_location_pin();this.update_custom_label(a.formatted_address);this.standard_filter.check("custom-address");this.toggle_fake_inputs(!0);this.on_state_changed()};
pe.WhereFilter.prototype.popup_clicked=function(a){a.stopPropagation()};pe.WhereFilter.prototype.toggle_fake_inputs=function(a){$(".FakeInput").attr("checked",a)};pe.WhereFilter.prototype.read_search_configuration=function(a){var b=a.filter_value("where"),c=a.filter_value("address");_.isEmpty(b)||this.standard_filter.read_search_configuration(a);_.isEmpty(c)||this.custom_saved(c)};pe.WhereFilter.prototype.reset=function(){this.custom_location=null;this.revert_custom_address();this.standard_filter.reset()};
pe.WhereFilter.prototype.popup_cancel_clicked=function(a){a=$(a.target).hasClass("FakeInput");this.location_popup.is(":visible")&&!a&&(this.location_popup.hide(),this.revert_custom_address())};pe.WhereFilter.prototype.popup_done_clicked=function(){this.custom_saved(this.location_popup.find(".CustomLocationInput").val())};pe.WhereFilter.prototype.popup_key_pressed=function(a){13===a.which&&this.popup_done_clicked()};
pe.WhereFilter.prototype.popup_result_clicked=function(a){this.on_custom_location_selected(this.custom_location_results[$(a.target).closest(".Item").attr("data_position")]);this.clear_results_list();this.location_popup.hide()};
pe.WhereFilter.prototype.revert_custom_address=function(){var a=this.custom_location?this.custom_location.address:pe.WhereFilter.DEFAULT_LOCATION_LABEL;this.update_custom_label(a);a===pe.WhereFilter.DEFAULT_LOCATION_LABEL&&(this.custom_location=null,this.standard_filter.uncheck("custom-address"),this.toggle_fake_inputs(!1))};pe.WhereFilter.prototype.set_facets=function(a){this.standard_filter.set_facets(a)};pe.WhereFilter.prototype.set_selection_facets=function(a){this.standard_filter.set_selection_facets(a)};
pe.WhereFilter.prototype.show_geocode_error=function(a){this.clear_results_list();a=a?"<div>The geocoder returned the error '"+a+"'. Please try again later.</div>":"Can't find that location. Please try again.";this.location_popup.find(".CustomLocationInput").focus();this.location_popup.find(".ErrorMessage").html(a)};
pe.WhereFilter.prototype.show_location_popup=function(a){a=a.position();this.location_popup.position({left:a.left+pe.WhereFilter.POPUP_OFFSET_LEFT,top:a.top+pe.WhereFilter.POPUP_OFFSET_TOP});this.location_popup.show();this.location_popup.find("input").focus()};
pe.WhereFilter.prototype.show_multiple_location_results=function(){this.location_popup.find(".ErrorMessage").empty();var a=this.location_popup.find(".ResultsList"),b=a.find(".Results");a.find(".Title").html(this.multiple_location_results_title_html(this.custom_location_results.length));a=this.multiple_location_results_list_html();b.html(a);b.click(this.callback(this.popup_result_clicked))};
pe.WhereFilter.prototype.update_custom_label=function(a){var b=this.standard_filter.all_container.find(".CustomLocationLabel"),c=pe.truncate_by_words(a,pe.WhereFilter.DEFAULT_TRUNCATION_LIMIT);this.standard_filter.all_container.find(".LongLabel").remove();this.custom_location_label.html(c);c===a?b.removeClass("short_label"):(b.addClass("short_label"),b.after('<label class="LongLabel long_label small_text">'+a+"</label>"),this.standard_filter.all_container.find(".LongLabel").click(this.callback(this.custom_label_clicked)))};
pe.WhereFilter.prototype.update_custom_location_pin=function(){this.map.add_marker({type:pe.Map2.marker_types.USER_LOCATION,latitude:this.custom_location.latitude,longitude:this.custom_location.longitude,icon:pe.Map2.icon_path(pe.Map2.marker_types.USER_LOCATION,""),bubble_html:'<div class="tooltip_content venue"><div class="point_wrapper"><div class="point"></div><div class="inner_point"></div></div><p class="result_name">Your location: </p><p class="result_types">'+this.custom_location.address+"</p></div>"})};
