pe.CloseButton=function(e,t){if(pe.init_widget(this,e),this.close_button=e.find(".CloseButton"),"function"==typeof t)this.close_button.click(t);else switch(t){case pe.CloseButton.close_methods.REMOVE:this.close_button.click(this.callback(this.remove_container));break;case pe.CloseButton.close_methods.HIDE:this.close_button.click(this.callback(this.hide_container));break;default:alert("unknown value for 'close_method' parameter.")}},pe.CloseButton.close_methods={REMOVE:"REMOVE",HIDE:"HIDE"},pe.CloseButton.events={CLOSED:"CloseButton_CLOSED"},pe.CloseButton.prototype.remove_container=function(){return this.container.detach(),this.fire_event(pe.CloseButton.events.CLOSED),this.container.remove(),!1},pe.CloseButton.prototype.hide_container=function(){return this.fire_event(pe.CloseButton.events.CLOSED),this.container.hide(),!1},pe.SingleSelectionAutocompleteField=function(e,t,i,o){pe.init_widget(this,e),this.on_item_selected=null,this.close_button_callback=null,this.autocomplete_data_or_url=t,this.input_field_name=i,this.container.html(this.html()),this.dummy_input_field=this.container.find(".DummyInputField"),this.messaging_area=this.container.find(".Messaging"),this.autocomplete_input_field=this.container.find(".AutocompleteField"),this.autocomplete_handler(),this.selected_data_container=this.container.find(".SelectedValue"),o&&this.set_field_value(o)},pe.SingleSelectionAutocompleteField.events={SELECTED:"SingleSelectionAutocompleteField_SELECTED"},pe.SingleSelectionAutocompleteField.prototype.set_autocomplete_url=function(e){e&&(this.autocomplete_data_or_url=e,this.autocomplete_handler())},pe.SingleSelectionAutocompleteField.prototype.set_field_value=function(e){e&&0!==e.length&&(this.remove_dummy_row(),this.autocomplete_data_selected(e),this.enforce_limit())},pe.SingleSelectionAutocompleteField.prototype.add_dummy_row=function(){this.dummy_input_field||(this.dummy_input_field=$('<input class="DummyInputField"        type="hidden" name="'+this.input_field_name+'"       value="x_mock_single_value_x">'),this.autocomplete_input_field.after(this.dummy_input_field))},pe.SingleSelectionAutocompleteField.prototype.autocomplete_data_selected=function(e){this.selected_data=e,this.remove_dummy_row(),this.selected_data_container.append(this.selected_data_html(e.label,e.id,e.category)),new pe.CloseButton(this.selected_data_container.find(".SelectedInputData").last(),pe.CloseButton.close_methods.REMOVE).bind_event(pe.CloseButton.events.CLOSED,this.callback(this.close_button_clicked)),this.enforce_limit(),this.on_item_selected&&this.on_item_selected(e)},pe.SingleSelectionAutocompleteField.prototype.item_selected=function(e){this.on_item_selected=e},pe.SingleSelectionAutocompleteField.prototype.autocomplete_handler=function(){this.autocomplete_input_field.autocomplete({source:this.autocomplete_data_or_url,minLength:1,focus:function(){return!1},close:this.callback(function(){this.autocomplete_input_field.val("")}),select:this.callback(function(e,t){var i=t.item;this.autocomplete_data_selected(i),this.fire_event(pe.SingleSelectionAutocompleteField.events.SELECTED,i.id)})}).data("autocomplete")._renderItem=function(e,t){return t.display_label=t.category?pe.templatize("{{label}} ({{category}})",t):t.label,$("<li></li>").data("item.autocomplete",t).append(pe.templatize("<a>{{display_label}}</a>",t)).appendTo(e)}},pe.SingleSelectionAutocompleteField.prototype.clear_selected_data=function(){this.selected_data_container.html(""),this.add_dummy_row()},pe.SingleSelectionAutocompleteField.prototype.close_button_clicked=function(){0===this.selected_data_container.find(".SelectedInputData").length&&this.add_dummy_row(),this.enforce_limit(),this.close_button_callback&&this.close_button_callback(),this.autocomplete_input_field.show(),this.autocomplete_input_field.focus()},pe.SingleSelectionAutocompleteField.prototype.display_close_button=function(){this.selected_data_container.find(".CloseButton").show()},pe.SingleSelectionAutocompleteField.prototype.enforce_limit=function(){0<this.selected_data_container.find(".SelectedInputData").length?this.autocomplete_input_field.autocomplete("disable"):this.autocomplete_input_field.autocomplete("enable")},pe.SingleSelectionAutocompleteField.prototype.hide_close_button=function(){this.selected_data_container.find(".CloseButton").hide()},pe.SingleSelectionAutocompleteField.prototype.html=function(){return'<input class="AutocompleteField" type="text"><input class="DummyInputField" type="hidden" name="'+this.input_field_name+'" value="x_mock_single_value_x"><div class="SelectedValue"></div>'},pe.SingleSelectionAutocompleteField.prototype.remove_dummy_row=function(){this.dummy_input_field&&(this.dummy_input_field.remove(),this.dummy_input_field=null)},pe.SingleSelectionAutocompleteField.prototype.replace_data_in_list=function(e){this.clear_selected_data(),this.set_field_value(e)},pe.SingleSelectionAutocompleteField.prototype.selected_data_html=function(e,t,i){return'<div class="SelectedInputData selected_data"><img style="margin-right:20px; width: 15px; height: 15px;" src="/assets/events/close.png"class="CloseButton float_left">  <div>'+(i?e+"("+i+")":e)+'</div>  <input type="hidden" value="'+t+'" name="'+this.input_field_name+'"></div>'},pe.SingleSelectionAutocompleteField.prototype.val=function(){return this.dummy_input_field?"":this.container.find('input[name="'+this.input_field_name+'"]').val()},pe.SeeMoreButton=function(e,t){pe.init_widget(this,e),this.options={item_container_id:e.attr("rel"),initial_page_number:1,item_class:"Paginable",per_page:16,server_url:"index.ehtml",autoload:!0},$.extend(this.options,t),this.current_page_number=this.options.initial_page_number,this.item_container=$("#"+this.options.item_container_id),this.on_page_loaded=this.options.on_page_loaded,this.options.per_page=this.item_container.find("."+this.options.item_class).length||this.options.per_page,this.next_page_content="",this.container.click(this.callback(this.show_next_page)),this.hide(),this.options.autoload&&this.load_next_page()},pe.SeeMoreButton.prototype.load_next_page=function(e){var t=this.url()+"page="+(this.current_page_number+1)+"&per_page="+this.options.per_page;$.get(t,null,e||this.callback(this.set_next_page_content))},pe.SeeMoreButton.prototype.set_next_page_content=function(e){this.next_page_content=e,this.refresh_photo_links(),/\S/.test(e)?this.show():this.hide(),this.on_page_loaded&&"function"==typeof this.on_page_loaded&&this.on_page_loaded()},pe.SeeMoreButton.prototype.refresh_photo_links=function(){window.location.href.match(/events/)&&$(".Paginable a").each(function(){var e=pe.fetch_photo_id_from_url($(this).attr("href")+"");$(this).attr("href",window.location+"/"+e)})},pe.SeeMoreButton.prototype.reset=function(){this.current_page_number=this.options.initial_page_number,this.container.show()},pe.SeeMoreButton.prototype.show_next_page=function(){return"function"==typeof this.options.on_click&&this.options.on_click(),this.options.autoload?(this.item_container.append(this.next_page_content),this.current_page_number+=1,this.load_next_page()):this.load_next_page(this.callback(function(e){this.item_container.append(e),this.current_page_number+=1,this.container.toggle(!_.isEmpty(e)),this.on_page_loaded&&"function"==typeof this.on_page_loaded&&this.on_page_loaded()})),!1},pe.SeeMoreButton.prototype.url=function(){var e;return e="function"==typeof this.options.server_url?this.options.server_url():this.options.server_url,e+=/\?/.test(e)?"&":"?"},function(h){h.extend(h.fn,{swapClass:function(e,t){var i=this.filter("."+e);return this.filter("."+t).removeClass(t).addClass(e),i.removeClass(e).addClass(t),this},replaceClass:function(e,t){return this.filter("."+e).removeClass(e).addClass(t).end()},hoverClass:function(e){return e=e||"hover",this.hover(function(){h(this).addClass(e)},function(){h(this).removeClass(e)})},heightToggle:function(e,t){e?this.animate({height:"toggle"},e,t):this.each(function(){jQuery(this)[jQuery(this).is(":hidden")?"show":"hide"](),t&&t.apply(this,arguments)})},heightHide:function(e,t){e?this.animate({height:"hide"},e,t):(this.hide(),t&&this.each(t))},prepareBranches:function(e){return e.prerendered||(this.filter(":last-child:not(ul)").addClass(p.last),this.filter((e.collapsed?"":"."+p.closed)+":not(."+p.open+")").find(">ul").hide()),this.filter(":has(>ul)")},applyClasses:function(e,t){if(this.filter(":has(>ul):not(:has(>a))").find(">span").unbind("click.treeview").bind("click.treeview",function(e){this==e.target&&t.apply(h(this).next())}).add(h("a",this)).hoverClass(),!e.prerendered){this.filter(":has(>ul:hidden)").addClass(p.expandable).replaceClass(p.last,p.lastExpandable),this.not(":has(>ul:hidden)").addClass(p.collapsable).replaceClass(p.last,p.lastCollapsable);var i=this.find("div."+p.hitarea);i.length||(i=this.prepend('<div class="'+p.hitarea+'"/>').find("div."+p.hitarea)),i.removeClass().addClass(p.hitarea).each(function(){var e="";h.each(h(this).parent().attr("class").split(" "),function(){e+=this+"-hitarea "}),h(this).addClass(e)})}this.find("div."+p.hitarea).click(t)},treeview:function(t){function e(t,e){function i(e){return function(){return o.apply(h("div."+p.hitarea,t).filter(function(){return!e||h(this).parent("."+e).length})),!1}}h("a:eq(0)",e).click(i(p.collapsable)),h("a:eq(1)",e).click(i(p.expandable)),h("a:eq(2)",e).click(i())}function o(){h(this).parent().find(">.hitarea").swapClass(p.collapsableHitarea,p.expandableHitarea).swapClass(p.lastCollapsableHitarea,p.lastExpandableHitarea).end().swapClass(p.collapsable,p.expandable).swapClass(p.lastCollapsable,p.lastExpandable).find(">ul").heightToggle(t.animated,t.toggle),t.unique&&h(this).parent().siblings().find(">.hitarea").replaceClass(p.collapsableHitarea,p.expandableHitarea).replaceClass(p.lastCollapsableHitarea,p.lastExpandableHitarea).end().replaceClass(p.collapsable,p.expandable).replaceClass(p.lastCollapsable,p.lastExpandable).find(">ul").heightHide(t.animated,t.toggle)}function i(){var i=[];s.each(function(e,t){i[e]=h(t).is(":has(>ul:visible)")?1:0}),h.cookie(t.cookieId,i.join(""),t.cookieOptions)}function n(){var e=h.cookie(t.cookieId);if(e){var i=e.split("");s.each(function(e,t){h(t).find(">ul")[parseInt(i[e])?"show":"hide"]()})}}if((t=h.extend({cookieId:"treeview"},t)).toggle){var a=t.toggle;t.toggle=function(){return a.apply(h(this).parent()[0],arguments)}}this.data("toggler",o),this.addClass("treeview");var s=this.find("li").prepareBranches(t);switch(t.persist){case"cookie":var l=t.toggle;t.toggle=function(){i(),l&&l.apply(this,arguments)},n();break;case"location":var r=this.find("a").filter(function(){return this.href.toLowerCase()==location.href.toLowerCase()});if(r.length){var c=r.addClass("selected").parents("ul, li").add(r.next()).show();t.prerendered&&c.filter("li").swapClass(p.collapsable,p.expandable).swapClass(p.lastCollapsable,p.lastExpandable).find(">.hitarea").swapClass(p.collapsableHitarea,p.expandableHitarea).swapClass(p.lastCollapsableHitarea,p.lastExpandableHitarea)}}return s.applyClasses(t,o),t.control&&(e(this,t.control),h(t.control).show()),this}}),h.treeview={};var p=h.treeview.classes={open:"open",closed:"closed",expandable:"expandable",expandableHitarea:"expandable-hitarea",lastExpandableHitarea:"lastExpandable-hitarea",collapsable:"collapsable",collapsableHitarea:"collapsable-hitarea",lastCollapsableHitarea:"lastCollapsable-hitarea",lastCollapsable:"lastCollapsable",lastExpandable:"lastExpandable",last:"last",hitarea:"hitarea"}}(jQuery),function(l){var t={topSpacing:0,bottomSpacing:0,className:"is-sticky",wrapperClassName:"sticky-wrapper",center:!1,getWidthFrom:""},r=l(window),c=l(document),h=[],p=r.height(),e=function(){for(var e=r.scrollTop(),t=c.height(),i=t-p,o=i<e?i-e:0,n=0;n<h.length;n++){var a=h[n];if(e<=a.stickyWrapper.offset().top-a.topSpacing-o)null!==a.currentTop&&(a.stickyElement.css("position","").css("top",""),a.stickyElement.parent().removeClass(a.className),a.currentTop=null);else{var s=t-a.stickyElement.outerHeight()-a.topSpacing-a.bottomSpacing-e-o;s<0?s+=a.topSpacing:s=a.topSpacing,a.currentTop!=s&&(a.stickyElement.css("position","fixed").css("top",s),"undefined"!=typeof a.getWidthFrom&&a.stickyElement.css("width",l(a.getWidthFrom).width()),a.stickyElement.parent().addClass(a.className),a.currentTop=s)}}},i=function(){p=r.height()},o={init:function(e){var i=l.extend(t,e);return this.each(function(){var e=l(this);stickyId=e.attr("id"),wrapper=l("<div></div>").attr("id",stickyId+"-sticky-wrapper").addClass(i.wrapperClassName),e.wrapAll(wrapper),i.center&&e.parent().css({width:e.outerWidth(),marginLeft:"auto",marginRight:"auto"}),"right"==e.css("float")&&e.css({"float":"none"}).parent().css({"float":"right"});var t=e.parent();t.css("height",e.outerHeight()),h.push({topSpacing:i.topSpacing,bottomSpacing:i.bottomSpacing,stickyElement:e,currentTop:null,stickyWrapper:t,className:i.className,getWidthFrom:i.getWidthFrom})})},update:e};window.addEventListener?(window.addEventListener("scroll",e,!1),window.addEventListener("resize",i,!1)):window.attachEvent&&(window.attachEvent("onscroll",e),window.attachEvent("onresize",i)),l.fn.sticky=function(e){return o[e]?o[e].apply(this,Array.prototype.slice.call(arguments,1)):"object"!=typeof e&&e?void l.error("Method "+e+" does not exist on jQuery.sticky"):o.init.apply(this,arguments)},l(function(){setTimeout(e,0)})}(jQuery),pe.PhotoBloodhound=function(e){pe.init_widget(this,e),this.base_url="/admin/articles/photos.ehtml",this.filters_form=this.container.find(".Filters"),this.filters_form.submit(function(){return!1}),this.form=this.container.find(".PhotosForm"),this.form.parent().hide(),this.hider=this.container.find(".Hider"),this.hider.click(this.callback(this.hider_clicked)),this.last_checked=null,this.reset_button=this.container.find(".ResetButton"),this.reset_button.click(this.callback(this.reset)),this.search_button=this.container.find(".SearchButton"),this.search_button.click(this.callback(this.search_button_clicked)),this.subtagger=this.container.find(".Subtagger"),this.see_more_button=new pe.SeeMoreButton(this.container.find(".ShowMoreButton"),{autoload:!1,on_click:this.callback(this.init_loading),on_page_loaded:this.callback(this.reset_ui),server_url:this.callback(this.url)}),this.container.find(".TagsTree").treeview({collapsed:!0}),this.container.find(".Searcher").sticky({topSpacing:0}),this.filters_form.find("input, textarea, select").change(this.callback(function(){this.search_button.removeClass("disabled").removeAttr("disabled")})),this.filters_form.find(".FilterTrigger").click(function(e){$(e.currentTarget).toggleClass("blue_text"),$(e.currentTarget).parent(".Filter").find(".FilterOptions").toggle()}),this.container.find(".DeselectAllButton").click(this.callback(function(){this.form[0].reset(),this.update_counters()})),this.form.find("input").live("click",this.callback(this.photo_checked))},pe.PhotoBloodhound.prototype.init_loading=function(){this.search_button.addClass("disabled").attr("disabled","disabled"),this.container.find(".Spinner").removeClass("hidden"),this.form.parent().show()},pe.PhotoBloodhound.prototype.hider_clicked=function(){if(this.filters_form.toggle(!this.filters_form.is(":visible")),this.container.find(".sticky-wrapper").css("height",this.container.find(".Searcher").outerHeight()+"px"),this.filters_form.is(":visible"))this.container.find(".Debugger").html("Filters: ");else{var e="Filters: "+this.filters_form.serialize();e=(e=(e=e.replace(/utf8=[^&]+(&|$)/,"")).replace(/authenticity_token=[^&]+(&|$)/,"")).replace(/&/g,", "),e=(e=decodeURIComponent(e)).replace(/(\w+)\[\]=/g,"<b>$1</b>:&nbsp;"),this.container.find(".Debugger").html(e)}return!1},pe.PhotoBloodhound.prototype.photo_checked=function(e){if(this.last_checked&&e.shiftKey)for(var t=this.form.find("input"),i=t.index(this.last_checked),o=t.index(e.target),n=Math.min(i,o),a=Math.max(i,o),s=n;s<a;s++)this.last_checked.is(":checked")?$(t[s]).attr("checked","checked"):$(t[s]).removeAttr("checked");this.last_checked=$(e.target),this.update_counters()},pe.PhotoBloodhound.prototype.search_button_clicked=function(){return this.init_loading(),this.form.html(""),$.get(this.base_url,this.serialize(),this.callback(function(e){this.form.html(e),this.see_more_button.reset(),this.reset_ui()})),!1},pe.PhotoBloodhound.prototype.reset=function(){return this.filters_form[0].reset(),this.search_button.removeClass("disabled").removeAttr("disabled"),!1},pe.PhotoBloodhound.prototype.reset_ui=function(){this.container.find(".Spinner").addClass("hidden"),this.update_counters()},pe.PhotoBloodhound.prototype.serialize=function(){var e;if(this.subtagger.is(":checked")){this.container.find(".TagsTree>.Tag .Tag input:checked").addClass("Checked").removeAttr("checked");e=this.filters_form.serialize(),this.filters_form.find(".Checked").removeClass("Checked").attr("checked","checked")}else e=this.filters_form.serialize();return e},pe.PhotoBloodhound.prototype.update_counters=function(){this.container.find(".TotalCount").html(this.form.find("input[type=checkbox]").length),this.container.find(".SelectedCount").html(this.form.find("input:checked").length)},pe.PhotoBloodhound.prototype.url=function(){return this.base_url+"?"+this.serialize()},$(document).ready(function(){pe.bloodhound=new pe.PhotoBloodhound($(".Bloodhound")),pe.autocomplete=new pe.SingleSelectionAutocompleteField($(".DestinationAutocomplete"),"/api/articles/autocomplete","article_id",[]),$(".CopyPhotosButton").click(function(e){var t=$(e.target);t.addClass("disabled");var i=$(".PhotosForm").serialize()+"&article_id="+$(".SelectedInputData > input[name=article_id]").val();$.post("/admin/articles/photos/copy",i).success(function(){t.removeClass("disabled")})}),$(".Copier").sticky({topSpacing:0}),pe.init_page_framework()});