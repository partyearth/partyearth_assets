pe.Validator=function(a){this.message=a.message||"Invalid value.";this.callback=a.callback;this.unless_callback=a.unless||function(){return!1};this.options=a;this.value=a.value?a.value:function(b){return a.callback(b)}};pe.Validator.prototype.passed=function(a){return!!this.callback($(a))};pe.Validator.prototype.failed=function(a){return!this.passed(a)};pe.Validator.prototype.unless=function(){return this.unless_callback()};
(function(){pe.validation.promo_code_validator=new pe.Validator({message:"Invalid code",callback:function(a){a=$.trim(a.val());this.message="Invalid code";return _.isEmpty(a)?(this.message="Please enter a promo code",!1):25<a.length?(this.message="Length is limited by 25 characters",!1):/^[\w-_@.]+$/.test(a)}})}).call(this);
pe.routes.map={search_autocomplete:"{{city_id}}/search/autocomplete.ehtml/",api_user_list:"/api/user_lists/{{id}}",api_reorder_user_list:"/api/user_lists/{{id}}/reorder",api_user_list_favorites:"/api/user_lists/{{id}}/favorites",api_favorite:"/api/favorites/{{id}}",api_favorite_vote_yes:"/api/favorites/{{id}}/vote_yes",api_favorite_vote_huh:"/api/favorites/{{id}}/vote_huh",holiday:"/{{city_id}}/holidays/{{id}}-7",holiday_comments:"/services/holidays/{{id}}/comments",holiday_reactions:"/holidays/{{id}}/reactions/all",
new_holiday_reactions:"/holidays/{{id}}/reactions",holiday_calendar:"/{{city_id}}/holidays/{{id}}-7/calendar",holiday_photos:"/api/{{city_id}}/holidays/{{id}}/photos",holiday_map_venues:"/api/maps/holidays/{{slug}}/venues",holiday_map_events:"/api/maps/holidays/{{slug}}/events",venue_map_popup:"/venues/{{venue_id}}/map_popup",map_venues:"/api/cities/{{city_id}}/maps/venues",map_events:"/api/cities/{{city_id}}/maps/events",map_neighborhood_venues:"/api/maps/neighborhoods/{{neighborhood_id}}/venues",
map_neighborhood_events:"/api/maps/neighborhoods/{{neighborhood_id}}/events",map_neighborhood_endpoint_venues:"/api/maps/neighborhoods/{{neighborhood_id}}/endpoints/{{endpoint_id}}/venues",map_neighborhood_endpoint_events:"/api/maps/neighborhoods/{{neighborhood_id}}/endpoints/{{endpoint_id}}/events",user_list_map_venues:"/api/maps/users/{{user_id}}/lists/{{id}}/venues",user_list_map_events:"/api/maps/users/{{user_id}}/lists/{{id}}/events",create_button_user_dashboard_event:"/users/{{user_id}}/dashboard/buttons/{{id}}",
generate_button_user_dashboard_event:"/users/{{user_id}}/dashboard/buttons/{{id}}/generate",boxoffice:"/users/{{user_id}}/dashboard/{{id}}/boxoffice",boxoffice_check_ticket_number:"/users/{{user_id}}/dashboard/{{id}}/boxoffice/{{ticket_number}}/check",user_dashboard_detail:"/users/{{user_id}}/dashboard/{{id}}",user_dashboard_details:"/users/{{user_id}}/dashboard",user_list:"/users/{{user_id}}/lists/{{id}}",user_lists:"/users/{{user_id}}/lists",user_comments:"/users/{{user_id}}/comments",user_reviews:"/users/{{user_id}}/reviews",
list_items:"/lists/{{id}}/list_items",list_comments:"/services/lists/{{id}}/comments",list_reactions:"/lists/{{id}}/reactions/all",new_list_reactions:"/lists/{{id}}/reactions",user_personalities:"/users/{{id}}/personalities",user:"/users/{{id}}",api_user:"/api/users/{{id}}",event:"/{{city_id}}/{{*endpoints}}/{{id}}-1",tickets:"/{{city_id}}/{{*endpoints}}/{{id}}-1/tickets",purchase_tickets:"/{{city_id}}/{{*endpoints}}/{{id}}-1/tickets/purchase",tickets_purchase_form:"/{{city_id}}/{{*endpoints}}/{{id}}-1/tickets/purchase_form",
tickets_confirmation:"/{{city_id}}/{{*endpoints}}/{{id}}-1/tickets/confirmation",api_ticket_orders:"/api/ticket_orders",api_close_ticket_order:"/api/ticket_orders/{{id}}/close",api_apply_ticket_order_promo_code:"/api/ticket_orders/apply_promo",api_remove_ticket_order_promo_code:"/api/ticket_orders/remove_promo",api_ticket_orders_disable_pending:"/api/ticket_orders/disable_pending",api_ticket_orders_countdown_seconds:"/api/ticket_orders/countdown_seconds",api_ticket_order_status:"/api/ticket_orders/{{id}}/status",
admin_event_ticket_types:"/admin/events/{{event_id}}/ticket_types",admin_event_ticket_promo_codes:"/admin/events/{{event_id}}/ticket_promo_codes",update_status_admin_event_ticket_promo_codes:"/admin/events/{{event_id}}/ticket_promo_codes/{{id}}/update_status",event_type_tags:"/api/tags/event_types",find_your_scene:"/services/find_your_scene.ehtml",missing_info:"/services/contact_messages/missing_info.ehtml",send_message:"/services/contact_messages/",subscription_select:"/services/subscriptions/web.ehtml",
subscriptions_create:"/services/subscriptions/web",creeper_dialog:"/services/creeper.ehtml",creeper_subscribe:"/services/creeper/subscribe",creeper_close:"/services/creeper/close",character:"/pe-reviewers/{{id}}.ehtml",ask_party_earth:"/api/questions",mobile_subscribe:"/services/subscriptions/mobile",client_signup_form:"/clients/forms.ehtml"};
pe.routes.build_path=function(a,b){var c=pe.routes.map[a],e=c.match(/\{\{\*(.+)\}\}/);_.each(e,function(a){b[a]&&(b[a]=b[a].join("/"))});c=c.replace(/\*/,"");b=b||{};return pe.routes.clean_url(pe.templatize(c,b))};pe.routes.clean_url=function(a){return("/"+a).replace(/#[^$\/]+/,"").replace(/(^[^?]+)([^:])\/\//,"$1$2/").replace(/\/\//g,"/")};pe.routes.current_url_params=function(){var a=pe.routes.recognize_path(window.location.pathname);return a?a.params:{}};
pe.routes.recognize_path=function(a){a=pe.routes.clean_url(a);var b,c,e=_.find(_.keys(pe.routes.map),function(e){b=pe.routes.map[e];c=RegExp(b.replace(/\//g,"\\/").replace(/\{\{[^\{\}]+\}\}/g,"(.+)"));return c.test(a)});if(e){for(var f=_.map(b.match(/\{\{[^\}]+\}\}/g),function(a){return a.replace(/\{|\}/g,"")}),g=a.match(c).slice(1,99),h={params:{}},j=function(a){return!_.isEmpty(a)},d=0;d<f.length;d++)"*"==f[d][0]&&(f[d]=f[d].replace(/\*/g,""),g[d]=_.select(g[d].replace(/\*/g,"").split("/"),j)),
h.params[f[d]]=g[d];h.path_info={name:e,template:b};return h}return!1};pe.routes.Request=function(a,b,c){pe.routes.map[a]?(this.path=a,"object"!==typeof b&&(b={id:b}),this.params=b,this.callback=c):alert("This path is not registered in the routes map.")};pe.routes.Request.factory=function(a,b,c){return new pe.routes.Request(a,b,c)};pe.routes.Request.from_current_location=function(a,b,c){b=b||{};var e=pe.routes.current_url_params();return new pe.routes.Request(a,_.extend(e,b),c)};
pe.routes.Request.prototype.ajax=function(a,b){var c="function"===typeof b?b:this.callback;$.ajax({url:this.build_path(),data:this.params,type:a,success:c})};pe.routes.Request.prototype.build_path=function(){return pe.routes.build_path(this.path,this.params)};pe.routes.Request.prototype.get=function(a){this.ajax("GET",a)};pe.routes.Request.prototype.post=function(a){this.ajax("POST",a)};
(function(){var a=function(a,b){return function(){return a.apply(b,arguments)}},b=pe,c=function(b){var c=this;this.container=b;this.remove_promo=a(this.remove_promo,this);this.assign_promo=a(this.assign_promo,this);this.apply_promo=a(this.apply_promo,this);this.input=this.container.find(".Input");this.input.val(this.container.data("value"));this.input.keypress(function(a){if(13===a.keyCode)return a.stopPropagation(),a.preventDefault(),c.apply_promo()});this.hidden_input=this.container.find(".PromoInput");
this.apply_button=this.container.find(".ApplyCodeButton");this.remove_button=this.container.find(".RemoveCodeButton");this.apply_button.click(this.apply_promo);this.remove_button.click(this.remove_promo);this.container.find(".Toggler").click(function(){c.container.find(".Fields").show();c.container.find(".Toggler").hide();return c.input.focus()});this.error=this.container.find(".Error");this.message=this.container.find(".Message");this.container.data("valid")?this.assign_promo():this.initialize()};
c.prototype.promo_code_entered=function(){return!_.isEmpty(this.promo_code())};c.prototype.promo_code=function(){return this.input.val()};c.prototype.hide_error=function(){this.error.html("");return this.error.hide()};c.prototype.show_error=function(a){this.error.html("<span>"+a+"</span>");return this.error.show()};c.prototype.show_message=function(a){this.message.html(a);return this.message.show()};c.prototype.hide_message=function(){return this.message.hide()};c.prototype.initialize=function(){this.promo_code_entered()?
(this.container.find(".Toggler").hide(),this.container.find(".Fields").show()):(this.container.find(".Fields").hide(),this.container.find(".Toggler").show());this.input.show();return this.apply_button.show()};c.prototype.apply_promo=function(){return pe.validation.promo_code_validator.passed(this.input)?(this.error.hide(),this.apply_button.html("Please wait...").addClass("disabled"),window.location=window.location.href.replace(/\?promo.*/,"")+("?promo="+this.promo_code())):this.show_error(pe.validation.promo_code_validator.message)};
c.prototype.assign_promo=function(){this.container.find(".Fields").show();this.container.find(".Toggler").hide();this.input.hide();this.apply_button.hide();this.error.hide();this.show_message("Promo Applied: "+this.promo_code());this.remove_button.show();this.hidden_input.attr("name",this.hidden_input.data("name"));return this.hidden_input.val(this.promo_code())};c.prototype.remove_promo=function(){this.error.hide();this.remove_button.addClass("disabled").html("Please wait...");this.hidden_input.removeAttr("name");
return window.location=window.location.href.replace(/\?promo.*/,"")};b.TicketPromoApplier=c}).call(this);
